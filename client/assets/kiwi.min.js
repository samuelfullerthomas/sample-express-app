!function(e,t){function n(){this._listeners={},this._parent=null,this._children=[]}function i(e){var t,n,i="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",s="";for(t=0;t<e;t++)n=Math.floor(Math.random()*i.length),s+=i.substring(n,n+1);return s}function s(e){var t,n,i,s,a,o;return t=Math.floor(e/3600),s=e%3600,n=Math.floor(s/60),a=s%60,i=Math.ceil(a),o={h:t,m:n,s:i}}function a(){this.recursive_depth=3,this.aliases={},this.vars={version:1};var e=0;this.processInput=function(e){var t,n=e||[],i=this.aliases[n[0].toLowerCase()],s="",a=[];if(!i)return e;i=i.split(" "),t=i.length;for(var o=0;o<t;o++)if(s=i[o],"$"===s[0])if(isNaN(s[1]))"undefined"==typeof this.vars[s.substr(1)]||a.push(this.vars[s.substr(1)]);else{var c=s.match(/\$(\d+)(\+)?(\d+)?/);if(!c||!n[c[1]])continue;"+"===c[2]&&c[3]?a=a.concat(n.slice(parseInt(c[1],10),parseInt(c[1],10)+parseInt(c[3],10))):"+"===c[2]?a=a.concat(n.slice(parseInt(c[1],10))):a.push(n[parseInt(c[1],10)])}else a.push(s);return a},this.process=function(t){t=t||"";var n=t.split(" "),i=(n[0]||"").toLowerCase();return e++,e>=this.recursive_depth?(e--,t):(this.aliases[i]&&(n=this.processInput(n),i=(n[0]||"").toLowerCase(),this.aliases[i]&&(n=this.process(n.join(" ")).split(" "))),e--,n.join(" "))}}function o(e,t,n){function i(e,t,n){var i;return n<0?n+=1:n>1&&(n-=1),i=6*n<1?e+(t-e)*n*6:2*n<1?t:3*n<2?e+(t-e)*(2/3-n)*6:e,255*i}var s,a,o,c,l,r;return t/=100,n/=100,0==t?c=l=r=255*n:(a=n<=.5?n*(t+1):n+t-n*t,s=2*n-a,o=e/360,c=i(s,a,o+1/3),l=i(s,a,o),r=i(s,a,o-1/3)),[c,l,r]}function c(e){e=e.replace(/%C(\d)/g,function(e,t){return String.fromCharCode(3)+t.toString()});var t={B:"",I:"",U:"",O:""};return e=e.replace(/%([BIUO])/g,function(e,n){if("undefined"!=typeof t[n.toUpperCase()])return t[n.toUpperCase()]})}function l(e){"use strict";var t,n="",i="",s={bold:!1,italic:!1,underline:!1,colour:!1},a=function(){var e,t="";return s.bold||s.italic||s.underline||s.colour?(t+=s.bold?"font-weight: bold; ":"",t+=s.italic?"font-style: italic; ":"",t+=s.underline?"text-decoration: underline; ":"",s.colour&&(e=s.colour.split(","),t+="color: "+e[0]+(e[1]?"; background-color: "+e[1]+";":"")),'<span class="format_span" style="'+t+'">'):""},o=function(e){var t=/^\x03(([0-9][0-9]?)(,([0-9][0-9]?))?)/;return t.exec(e)},c=function(e){switch(parseInt(e,10)){case 0:return"#FFFFFF";case 1:return"#000000";case 2:return"#000080";case 3:return"#008000";case 4:return"#FF0000";case 5:return"#800040";case 6:return"#800080";case 7:return"#FF8040";case 8:return"#FFFF00";case 9:return"#80FF00";case 10:return"#008080";case 11:return"#00FFFF";case 12:return"#0000FF";case 13:return"#FF55FF";case 14:return"#808080";case 15:return"#C0C0C0";default:return null}},l=0,r=[];for(l=0;l<e.length;l++)switch(e[l]){case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.bold=!s.bold,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.italic=!s.italic,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.underline=!s.underline,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),t=o(e.substr(l,6)),t?(l+=t[1].length,r[0]=c(t[2]),t[4]&&(r[1]=c(t[4])),s.colour=r.join(",")):s.colour=!1,i=a();break;case"":(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),s.bold=s.italic=s.underline=s.colour=!1;break;default:s.bold||s.italic||s.underline||s.colour?i+=e[l]:n+=e[l]}return(s.bold||s.italic||s.underline||s.colour)&&(n+=i+"</span>"),n}function r(e){return e.replace(/[\[\]\\\^\$\.\|\?\*\+\-\(\)]/g,"\\$&")}function h(e){var t,n=e.split(" "),i=[],s=function(e,t){i.push('<i class="emoticon '+t+'">'+e+"</i>")};for(t=0;t<n.length;t++)switch(n[t]){case":)":s(":)","smile");break;case":(":s(":(","sad");break;case":3":s(":3","lion");break;case";3":s(";3","winky_lion");break;case":s":case":S":s(":s","confused");break;case";(":case";_;":s(";(","cry");break;case";)":s(";)","wink");break;case";D":s(";D","wink_happy");break;case":P":case":p":s(":P","tongue");break;case"xP":s("xP","cringe_tongue");break;case":o":case":O":case":0":s(":o","shocked");break;case":D":s(":D","happy");break;case"^^":case"^.^":s("^^,","eyebrows");break;case"&lt;3":s("<3","heart");break;case"&gt;_&lt;":case"&gt;.&lt;":s(">_<","doh");break;case"XD":case"xD":s("xD","big_grin");break;case"o.0":case"o.O":s("o.0","wide_eye_right");break;case"0.o":case"O.o":s("0.o","wide_eye_left");break;case":\\":case"=\\":case":/":case"=/":s(":\\","unsure");break;default:i.push(n[t])}return i.join(" ")}function d(e){if(Date.prototype.toISOString)return new Date(e);var t=e.split("T"),n=t[0].split("-"),i=t[1].split("Z"),s=i[0].split(":"),a=s[2].split("."),o=Number(s[0]),c=new Date;return c.setUTCFullYear(Number(n[0])),c.setUTCDate(1),c.setUTCMonth(Number(n[1])-1),c.setUTCDate(Number(n[2])),c.setUTCHours(Number(o)),c.setUTCMinutes(Number(s[1])),c.setUTCSeconds(Number(a[0])),a[1]&&c.setUTCMilliseconds(Number(a[1])),c}function p(e,t){return t=t||"",g.global.i18n.translate(e).fetch(t)}function u(e,t){var n,i;return n=g.app.text_theme[e],n=c(n),t.member&&(t.nick=t.member.nick||"",t.ident=t.member.ident||"",t.host=t.member.hostname||"",t.prefix=t.member.prefix||""),i=n.replace(/%([A-Z]{2,})/gi,function(e,n){if("undefined"!=typeof t[n])return t[n]})}function m(e,t){var n=e.match(/([^!@]+)!?([^!@]+)?@?(.+)?/),i=(n[1]||"*")+"!"+(n[2]||"*")+"@"+(n[3]||"*");return t?[i,new RegExp("^"+i.toLowerCase().replace(/\./g,"\\.").replace(/\*/g,"(.[^!@]*?)")+"$","i")]:i}var g={};if(g.misc={},g.model={},g.view={},g.applets={},g.utils={},g.global={build_version:"",settings:t,plugins:t,events:t,rpc:t,utils:{},initUtils:function(){this.utils.randomString=i,this.utils.secondsToTime=s,this.utils.parseISO8601=d,this.utils.escapeRegex=r,this.utils.formatIRCMsg=l,this.utils.styleText=u,this.utils.hsl2rgb=o,this.utils.toUserMask=m,this.utils.notifications=g.utils.notifications,this.utils.formatDate=g.utils.formatDate},addMediaMessageType:function(e,t){g.view.MediaMessage.addType(e,t)},components:{EventComponent:function(e,t){function n(e,n){"all"==t||(n=e.event_data,e=e.event_name),this.trigger(e,n)}t=t||"all",_.extend(this,Backbone.Events),this._source=e,e.on(t,n,this),this.dispose=function(){e.off(t,n),this.off(),delete this.event_source}},Network:function(e){var n;n="undefined"!=typeof e?"connection:"+e.toString():"connection";var i=function(){var n="undefined"==typeof e?g.app.connections.active_connection:g.app.connections.getByConnectionId(e);return n?n:t},s=new this.EventComponent(g.gateway,n),a={kiwi:"kiwi",raw:"raw",kick:"kick",topic:"topic",part:"part",join:"join",action:"action",ctcp:"ctcp",ctcpRequest:"ctcpRequest",ctcpResponse:"ctcpResponse",notice:"notice",msg:"privmsg",say:"privmsg",changeNick:"changeNick",channelInfo:"channelInfo",mode:"mode",quit:"quit"};return _.each(a,function(t,n){s[n]=function(){var n=t,i=Array.prototype.slice.call(arguments,0);return i.unshift(e),g.gateway[n].apply(g.gateway,i)}}),s.createQuery=function(e){var t;if(t=i())return t.createQuery(e)},s.ignoreMask=function(e){var t=i();if(t)return t.ignore_list.addMask(e)},s.unignoreMask=function(e){var t=i();if(t)return t.ignore_list.removeMask(e)},s.get=function(e){var n,s;if(n=i())return s=["password"],s.indexOf(e)>-1?t:n.get(e)},s.set=function(){var e=i();if(e)return e.set.apply(e,arguments)},s},ControlInput:function(){var e=new this.EventComponent(g.app.controlbox),t={run:"processInput",addPluginIcon:"addPluginIcon"};return _.each(t,function(t,n){e[n]=function(){var e=t;return g.app.controlbox[e].apply(g.app.controlbox,arguments)}}),e.input=g.app.controlbox.$(".inp"),e}},init:function(e,t){var i,s,a=this;e=e||{},this.initUtils(),g.global.settings=g.model.DataStore.instance("kiwi.settings"),g.global.settings.load(),window.document.title=e.server_settings.client.window_title||"Kiwi IRC",i=new Promise(function(t){var n=g.global.settings.get("locale")||e.locale||e.server_settings.client.settings.locale||"magic";$.getJSON(e.base_path+"/assets/locales/"+n+".json",function(e){e?a.i18n=new Jed(e):a.i18n=new Jed,t()})}),s=new Promise(function(t){var n=e.server_settings.client.settings.text_theme||"default";$.getJSON(e.base_path+"/assets/text_themes/"+n+".json",function(n){e.text_theme=n,t()})}),Promise.all([i,s]).then(function(){g.app=new g.model.Application(e),g.app.initializeInterfaces(),g.global.events=new n,g.global.plugins=new g.model.PluginManager,t()}).then(null,function(e){console.error(e.stack)})},start:function(){g.app.showStartup()},registerStartupApplet:function(e){g.app.startup_applet_name=e},newIrcConnection:function(e,t){g.gateway.newConnection(e,t)},defaultServerSettings:function(){var e,t,n={nick:"",server:"",port:6667,ssl:!1,channel:"",channel_key:""};return g.app.server_settings.client&&(g.app.server_settings.client.nick&&(n.nick=g.app.server_settings.client.nick),g.app.server_settings.client.server&&(n.server=g.app.server_settings.client.server),g.app.server_settings.client.port&&(n.port=g.app.server_settings.client.port),g.app.server_settings.client.ssl&&(n.ssl=g.app.server_settings.client.ssl),g.app.server_settings.client.channel&&(n.channel=g.app.server_settings.client.channel),g.app.server_settings.client.channel_key&&(n.channel_key=g.app.server_settings.client.channel_key)),getQueryVariable("nick")&&(n.nick=getQueryVariable("nick")),window.location.hash&&(n.channel=window.location.hash),e=window.location.pathname.toString().replace(g.app.get("base_path"),"").split("/"),e.length>0&&(e.shift(),e.length>0&&e[0]&&(t=e[0].substr(0,7).toLowerCase(),"ircs%3a"===t||"irc%3a"===t.substr(0,6)?(e[0]=decodeURIComponent(e[0]),t=/^irc(s)?:(?:\/\/?)?([^:\/]+)(?::([0-9]+))?(?:(?:\/)([^\?]*)(?:(?:\?)(.*))?)?$/.exec(e[0]),t&&("undefined"!=typeof t[1]&&(n.ssl=!0,6667===n.port&&(n.port=6697)),n.server=t[2],"undefined"!=typeof t[3]&&(n.port=t[3]),"undefined"!=typeof t[4]&&(n.channel="#"===t[4][0]?t[4]:"#"+t[4],"undefined"!=typeof t[5]&&(n.channel_key=t[5]))),e=[]):(e[0].search(/:/)>0?(n.port=e[0].substring(e[0].search(/:/)+1),n.server=e[0].substring(0,e[0].search(/:/)),"+"===n.port[0]?(n.port=parseInt(n.port.substring(1),10),n.ssl=!0):n.ssl=!1):n.server=e[0],e.shift())),e.length>0&&e[0]&&(n.channel="#"+e[0],e.shift())),g.app.server_settings&&g.app.server_settings.connection&&(g.app.server_settings.connection.server&&(n.server=g.app.server_settings.connection.server),g.app.server_settings.connection.port&&(n.port=g.app.server_settings.connection.port),g.app.server_settings.connection.ssl&&(n.ssl=g.app.server_settings.connection.ssl)),n.nick=n.nick.replace(/\?/g,Math.floor(1e5*Math.random()).toString()),getQueryVariable("encoding")&&(n.encoding=getQueryVariable("encoding")),n}},"undefined"!=typeof e)e.kiwi=g.global;else{g.global}!function(){g.model.Application=Backbone.Model.extend({view:null,message:null,initialize:function(e){this.app_options=e,e.container&&this.set("container",e.container),this.set("base_path",e.base_path?e.base_path:""),this.set("settings_path",e.settings_path?e.settings_path:this.get("base_path")+"/assets/settings.json"),this.server_settings=e.server_settings||{},this.translations=e.translations||{},this.themes=e.themes||[],this.text_theme=e.text_theme||{},this.startup_applet_name=e.startup||"kiwi_startup",this.server_settings&&this.server_settings.client&&this.server_settings.client.settings&&this.applyDefaultClientSettings(this.server_settings.client.settings)},initializeInterfaces:function(){var e="";e="string"==typeof this.app_options.kiwi_server?this.app_options.kiwi_server:_.isArray(this.app_options.kiwi_server)?_.sample(this.app_options.kiwi_server):this.detectKiwiServer(),g.gateway=new g.model.Gateway({kiwi_server:e}),this.bindGatewayCommands(g.gateway),this.initializeClient(),this.initializeGlobals(),this.view.barsHide(!0)},detectKiwiServer:function(){return"file:"===window.location.protocol?"http://localhost:7778":window.location.protocol+"//"+window.location.host},showStartup:function(){this.startup_applet=g.model.Applet.load(this.startup_applet_name,{no_tab:!0}),this.startup_applet.tab=this.view.$(".console"),this.startup_applet.view.show(),g.global.events.emit("loaded")},initializeClient:function(){this.view=new g.view.Application({model:this,el:this.get("container")}),this.connections=new g.model.NetworkPanelList,this.connections.on("remove",_.bind(function(){0===this.connections.length&&this.view.barsHide()},this)),this.applet_panels=new g.model.PanelList,this.applet_panels.view.$el.addClass("panellist applets"),this.view.$el.find(".tabs").append(this.applet_panels.view.$el),this.controlbox=new g.view.ControlBox({el:$("#kiwi .controlbox")[0]}).render(),this.client_ui_commands=new g.misc.ClientUiCommands(this,this.controlbox),this.rightbar=new g.view.RightBar({el:this.view.$(".right_bar")[0]}),this.topicbar=new g.view.TopicBar({el:this.view.$el.find(".topic")[0]}),new g.view.AppToolbar({el:g.app.view.$el.find(".toolbar .app_tools")[0]}),new g.view.ChannelTools({el:g.app.view.$el.find(".channel_tools")[0]}),this.message=new g.view.StatusMessage({el:this.view.$el.find(".status_message")[0]}),this.resize_handle=new g.view.ResizeHandler({el:this.view.$el.find(".memberlists_resize_handle")[0]}),this.view.doLayout()},initializeGlobals:function(){g.global.connections=this.connections,g.global.panels=this.panels,g.global.panels.applets=this.applet_panels,g.global.components.Applet=g.model.Applet,g.global.components.Panel=g.model.Panel,g.global.components.MenuBox=g.view.MenuBox,g.global.components.DataStore=g.model.DataStore,g.global.components.Notification=g.view.Notification,g.global.components.Events=function(){return g.global.events.createProxy()}},applyDefaultClientSettings:function(e){_.each(e,function(e,t){"undefined"==typeof g.global.settings.get(t)&&g.global.settings.set(t,e)})},panels:function(){var e,t=function(t){var n,i=g.app;switch(t=t||"connections"){case"connections":n=i.connections.panels();break;case"applets":n=i.applet_panels.models}return n.active=e,n.server=i.connections.active_connection?i.connections.active_connection.panels.server:null,n};return _.extend(t,Backbone.Events),t.bind("active",function(t){var n=e;e=t,g.global.events.emit("panel:active",{previous:n,active:e})}),t}(),bindGatewayCommands:function(e){var t=this;e.on("connection:connect",function(e){t.view.barsShow()}),function(){var n=0;e.on("disconnect",function(e){t.view.$el.removeClass("connected"),n=1}),e.on("reconnecting",function(e){var t=p("client_models_application_reconnect_in_x_seconds",[e.delay/1e3])+"...";g.app.connections.forEach(function(e){e.panels.server.addMsg("",u("quit",{text:t}),"action quit")})}),e.on("kiwi:connected",function(e){var i;t.view.$el.addClass("connected"),g.global.rpc=g.gateway.rpc,g.global.events.emit("connected"),1===n&&(n=0,i=p("client_models_application_reconnect_successfully")+" :)",t.message.text(i,{timeout:5e3}),g.app.connections.forEach(function(e){e.reconnect(),e.panels.server.addMsg("",u("rejoin",{text:i}),"action join"),e.panels.forEach(function(e){e.isChannel()&&(e.get("members").reset(),e.addMsg("",u("rejoin",{text:i}),"action join"))})}))})}(),e.on("kiwi:reconfig",function(){$.getJSON(t.get("settings_path"),function(e){t.server_settings=e.server_settings||{},t.translations=e.translations||{}})}),e.on("kiwi:jumpserver",function(e){var n;if("undefined"!=typeof e.kiwi_server&&(n=e.kiwi_server,"/"===n[n.length-1]&&(n=n.substring(0,n.length-1)),e.force)){var i=60*Math.random()+300;i=1;var s=g.global.i18n.translate("client_models_application_jumpserver_prepare").fetch();t.message.text(s,{timeout:1e4}),setTimeout(function(){var e=g.global.i18n.translate("client_models_application_jumpserver_reconnect").fetch();t.message.text(e,{timeout:8e3}),setTimeout(function(){g.gateway.set("kiwi_server",n),g.gateway.reconnect(function(){t.connections.forEach(function(e){e.reconnect()})})},5e3)},1e3*i)}}),e.on("kiwi:asset_files_changes",function(e){t.view.reloadStyles()})}})}(),g.model.Gateway=Backbone.Model.extend({initialize:function(){this.socket=this.get("socket"),this.disconnect_requested=!1},reconnect:function(e){this.disconnect_requested=!0,this.socket.close(),this.socket=null,this.connect(e)},connect:function(e){var t=this;this.connect_callback=e,this.socket=new EngineioTools.ReconnectingSocket(this.get("kiwi_server"),{transports:g.app.server_settings.transports||["polling","websocket"],path:g.app.get("base_path")+"/transport",reconnect_max_attempts:5,reconnect_delay:2e3}),this.rpc&&rpc.dispose(),this.rpc=new EngineioTools.Rpc(this.socket),this.socket.on("connect_failed",function(e){this.socket.disconnect(),this.trigger("connect_fail",{reason:e})}),this.socket.on("error",function(e){console.log("_kiwi.gateway.socket.on('error')",{reason:e}),t.connect_callback&&(t.connect_callback(e),delete t.connect_callback),t.trigger("connect_fail",{reason:e})}),this.socket.on("connecting",function(e){console.log("_kiwi.gateway.socket.on('connecting')"),t.trigger("connecting")}),this.socket.on("open",function(){t.disconnect_requested=!1;var e=function(){t.rpc&&(t.rpc("kiwi.heartbeat"),t._heartbeat_tmr=setTimeout(e,6e4))};e(),console.log("_kiwi.gateway.socket.on('open')")}),this.rpc.on("too_many_connections",function(){t.trigger("connect_fail",{reason:"too_many_connections"})}),this.rpc.on("irc",function(e,n){t.parse(n.command,n.data)}),this.rpc.on("kiwi",function(e,n){t.parseKiwi(n.command,n.data)}),this.socket.on("close",function(){t.trigger("disconnect",{}),console.log("_kiwi.gateway.socket.on('close')")}),this.socket.on("reconnecting",function(e){console.log("_kiwi.gateway.socket.on('reconnecting')"),t.trigger("reconnecting",{delay:e.delay,attempts:e.attempts})}),this.socket.on("reconnecting_failed",function(){console.log("_kiwi.gateway.socket.on('reconnect_failed')")})},newConnection:function(e,t){var n=this;return this.isConnected()?void this.makeIrcConnection(e,function(n,i){var s;if(n)console.log("_kiwi.gateway.socket.on('error')",{reason:n}),t&&t(n);else{if(!g.app.connections.getByConnectionId(i)){var a={connection_id:i,nick:e.nick,address:e.host,port:e.port,ssl:e.ssl,password:e.password};s=new g.model.Network(a),g.app.connections.add(s)}console.log("_kiwi.gateway.socket.on('connect')",s),t&&t(n,s)}}):void this.connect(function(i){return i?void t(i):void n.newConnection(e,t)})},makeIrcConnection:function(e,t){var n={nick:e.nick,hostname:e.host,port:e.port,ssl:e.ssl,password:e.password};e.options=e.options||{},e.options.encoding&&(n.encoding=e.options.encoding),this.rpc("kiwi.connect_irc",n,function(e,n){e?t&&t(e):t&&t(e,n)})},isConnected:function(){return this.socket},parseKiwi:function(e,t){var n;switch(e){case"connected":n={build_version:g.global.build_version},this.rpc("kiwi.client_info",n),this.connect_callback&&this.connect_callback(),delete this.connect_callback}this.trigger("kiwi:"+e,t),this.trigger("kiwi",t)},parse:function(e,t){var n="";"undefined"!=typeof t.connection_id&&(n="connection:"+t.connection_id.toString(),this.trigger(n,{event_name:e,event_data:t}),"message"==e&&t.type&&this.trigger("connection "+n,{event_name:"message:"+t.type,event_data:t}),"channel"==e&&t.type&&this.trigger("connection "+n,{event_name:"channel:"+t.type,event_data:t})),this.trigger("connection",{event_name:e,event_data:t}),this.trigger("connection:"+e,t)},rpcCall:function(e,t){var n=Array.prototype.slice.call(arguments,0);return"undefined"!=typeof n[1]&&null!==n[1]||(n[1]=g.app.connections.active_connection.get("connection_id")),this.rpc.apply(this.rpc,n)},privmsg:function(e,t,n,i){var s={target:t,msg:n};this.rpcCall("irc.privmsg",e,s,i)},notice:function(e,t,n,i){var s={target:t,msg:n};this.rpcCall("irc.notice",e,s,i)},ctcp:function(e,t,n,i,s,a){var o={is_request:t,type:n,target:i,params:s};this.rpcCall("irc.ctcp",e,o,a)},ctcpRequest:function(e,t,n,i,s){this.ctcp(e,!0,t,n,i,s)},ctcpResponse:function(e,t,n,i,s){this.ctcp(e,!1,t,n,i,s)},action:function(e,t,n,i){this.ctcp(e,!0,"ACTION",t,n,i)},join:function(e,t,n,i){var s={channel:t,key:n};this.rpcCall("irc.join",e,s,i)},channelInfo:function(e,t,n){var i={channel:t};this.rpcCall("irc.channel_info",e,i,n)},part:function(e,n,i,s){"use strict";"function"==typeof arguments[2]&&(s=arguments[2],i=t);var a={channel:n,message:i};this.rpcCall("irc.part",e,a,s)},topic:function(e,t,n,i){var s={channel:t,topic:n};this.rpcCall("irc.topic",e,s,i)},kick:function(e,t,n,i,s){var a={channel:t,nick:n,reason:i};this.rpcCall("irc.kick",e,a,s)},quit:function(e,t,n){t=t||"";var i={message:t};this.rpcCall("irc.quit",e,i,n)},raw:function(e,t,n){var i={data:t};this.rpcCall("irc.raw",e,i,n)},changeNick:function(e,t,n){var i={nick:t};this.rpcCall("irc.nick",e,i,n)},mode:function(e,t,n,i){var s={data:"MODE "+t+" "+n};this.rpcCall("irc.raw",e,s,i)},setEncoding:function(e,t,n){var i={encoding:t};this.rpcCall("irc.encoding",e,i,n)}}),function(){function e(e){this.set("connected",!1),$.each(this.panels.models,function(e,t){t.isApplet()||t.addMsg("",u("network_disconnected",{text:p("client_models_network_disconnected",[])}),"action quit")})}function n(e){var t;this.set("nick",e.nick),this.set("connected",!0),this.ignore_list.loadFromNetwork(this),this.rejoinAllChannels(),this.auto_join&&this.auto_join.channel&&(t=this.createAndJoinChannels(this.auto_join.channel+" "+(this.auto_join.key||"")),t&&t[t.length-1].view.show(),delete this.auto_join)}function i(e){var t=this;$.each(e.options,function(e,n){switch(e){case"CHANTYPES":t.set("channel_prefix",n.join(""));break;case"NETWORK":t.set("name",n);break;case"PREFIX":t.set("user_prefixes",n);break;case"NICKLEN":t.set("nick_max_length",parseInt(n,10));break;case"CHANNELLEN":t.set("channel_max_length",parseInt(n,10));break;case"TOPICLEN":t.set("topic_max_length",parseInt(n,10))}}),this.set("cap",e.cap)}function a(e){this.panels.server.addMsg(this.get("name"),u("motd",{text:e.msg}),"motd")}function o(e){var t,n,i;t=this.panels.getByName(e.channel),t||(t=new g.model.Channel({name:e.channel,network:this}),this.panels.add(t)),n=t.get("members"),n&&(n.getByNick(e.nick)||(i=new g.model.Member({nick:e.nick,ident:e.ident,hostname:e.hostname,user_prefixes:this.get("user_prefixes")}),g.global.events.emit("channel:join",{channel:e.channel,user:i,network:this.gateway}).then(function(){n.add(i,{kiwi:e})})))}function c(e){var t,n,i,s={};if(s.type="part",s.message=e.message||"",s.time=e.time,t=this.panels.getByName(e.channel)){if(e.nick===this.get("nick"))return void t.close();n=t.get("members"),n&&(i=n.getByNick(e.nick),i&&g.global.events.emit("channel:leave",{channel:e.channel,user:i,type:"part",message:s.message,network:this.gateway}).then(function(){n.remove(i,{kiwi:s})}))}}function l(e){var t,n={};n.type="quit",n.message=e.message||"",n.time=e.time,$.each(this.panels.models,function(i,s){s.isQuery()&&s.get("name").toLowerCase()===e.nick.toLowerCase()&&s.addMsg(" ",u("channel_quit",{nick:e.nick,text:p("client_models_channel_quit",[n.message])}),"action quit",{time:n.time}),s.isChannel()&&(t=s.get("members").getByNick(e.nick),t&&g.global.events.emit("channel:leave",{channel:s.get("name"),user:t,type:"quit",message:n.message,network:this.gateway}).then(function(){s.get("members").remove(t,{kiwi:n})}))})}function r(e){var t,n,i,s={};s.type="kick",s.by=e.nick,s.message=e.message||"",s.current_user_kicked=e.kicked==this.get("nick"),s.current_user_initiated=e.nick==this.get("nick"),s.time=e.time,t=this.panels.getByName(e.channel),t&&(n=t.get("members"),n&&(i=n.getByNick(e.kicked),i&&g.global.events.emit("channel:leave",{channel:e.channel,user:i,type:"kick",message:s.message,network:this.gateway}).then(function(){n.remove(i,{kiwi:s}),s.current_user_kicked&&n.reset([])})))}function h(e){g.global.events.emit("message:new",{network:this.gateway,message:e}).then(_.bind(function(){var t,n=(e.target||"").toLowerCase()==this.get("nick").toLowerCase();if(!this.isUserIgnored(e)){if("notice"==e.type)e.from_server?t=this.panels.server:(t=this.panels.getByName(e.target)||this.panels.getByName(e.nick),e.nick&&"chanserv"==e.nick.toLowerCase()&&"["==e.msg.charAt(0)&&(channel_name=/\[([^ \]]+)\]/gi.exec(e.msg),channel_name&&channel_name[1]&&(channel_name=channel_name[1],t=this.panels.getByName(channel_name)))),t||(t=this.panels.server);else if(n)if(t=this.panels.getByName(e.nick),t||g.global.settings.get("ignore_new_queries")){if(!t)return}else t=new g.model.Query({name:e.nick,network:this}),this.panels.add(t);else t=this.panels.getByName(e.target),t||(t=this.panels.server);switch(e.type){case"message":t.addMsg(e.nick,u("privmsg",{text:e.msg}),"privmsg",{time:e.time});break;case"action":t.addMsg("",u("action",{nick:e.nick,text:e.msg}),"action",{time:e.time});break;case"notice":t.addMsg("["+(e.nick||"")+"]",u("notice",{text:e.msg}),"notice",{time:e.time}),active_panel=g.app.panels().active,e.from_server||t!==this.panels.server||active_panel===this.panels.server||active_panel.get("network")===this&&(active_panel.isChannel()||active_panel.isQuery())&&active_panel.addMsg("["+(e.nick||"")+"]",u("notice",{text:e.msg}),"notice",{time:e.time})}}},this))}function d(e){var t;$.each(this.panels.models,function(n,i){i.get("name")==e.nick&&i.set("name",e.newnick),i.isChannel()&&(t=i.get("members").getByNick(e.nick),t&&(t.set("nick",e.newnick),i.addMsg("",u("nick_changed",{nick:e.nick,text:p("client_models_network_nickname_changed",[e.newnick]),channel:name}),"action nick",{time:e.time})))})}function f(e){this.isUserIgnored(e)||("TIME"===e.msg.toUpperCase()?this.gateway.ctcpResponse(e.type,e.nick,(new Date).toString()):"PING"===e.type.toUpperCase()&&this.gateway.ctcpResponse(e.type,e.nick,e.msg.substr(5)))}function v(e){this.isUserIgnored(e)||this.panels.server.addMsg("["+e.nick+"]",u("ctcp",{text:e.msg}),"ctcp",{time:e.time})}function w(e){var t;t=this.panels.getByName(e.channel),t&&(t.set("topic",e.topic),t.get("name")===this.panels.active.get("name")&&g.app.topicbar.setCurrentTopic(e.topic))}function k(e){var t,n;t=this.panels.getByName(e.channel),t&&(n=new Date(1e3*e.when),t.set("topic_set_by",{nick:e.nick,when:n}))}function b(e){var t=this.panels.getByName(e.channel);t&&(e.url?t.set("info_url",e.url):e.modes&&t.set("info_modes",e.modes))}function y(e){var t=this,n=this.panels.getByName(e.channel);n&&(n.temp_userlist=n.temp_userlist||[],_.each(e.users,function(e){var i=new g.model.Member({nick:e.nick,modes:e.modes,user_prefixes:t.get("user_prefixes")});n.temp_userlist.push(i)}))}function x(e){var t;t=this.panels.getByName(e.channel),t&&(t.get("members").reset(t.temp_userlist||[]),delete t.temp_userlist)}function C(e){var t=this.panels.getByName(e.channel);t&&t.set("banlist",e.bans||[])}function M(e){function n(t,n){var i,s={};return t||(t=e.modes,n=e.target),_.each(t,function(e){var t=e.param||n||"";s[t]||(s[t]={"+":"","-":""}),s[t][e.mode[0]]+=e.mode.substr(1)}),i=[],_.each(s,function(e,t){var n="";e["+"]&&(n+="+"+e["+"]),e["-"]&&(n+="-"+e["-"]),i.push(n+" "+t)}),i=i.join(", ")}var i,s,a,o,c,l,r=!1;if(i=this.panels.getByName(e.target)){for(a=this.get("user_prefixes"),l=function(t){return e.modes[s].mode[1]===t.mode},s=0;s<e.modes.length;s++){if(_.any(a,l)){if(o||(o=i.get("members")),c=o.getByNick(e.modes[s].param),!c)return void console.log("MODE command recieved for unknown member %s on channel %s",e.modes[s].param,e.target);"+"===e.modes[s].mode[0]?c.addMode(e.modes[s].mode[1]):"-"===e.modes[s].mode[0]&&c.removeMode(e.modes[s].mode[1]),o.sort()}"b"==e.modes[s].mode[1]&&(r=!0),"k"==e.modes[s].mode[1]&&("+"===e.modes[s].mode[0]?i.set("key",e.modes[s].param):"-"===e.modes[s].mode[0]&&i.set("key",t))}i.addMsg("",u("mode",{nick:e.nick,text:p("client_models_network_mode",[n()]),channel:e.target}),"action mode",{time:e.time}),r&&this.gateway.raw("MODE "+i.get("name")+" +b")}else e.target.toLowerCase()===this.get("nick").toLowerCase()?this.panels.server.addMsg("",u("selfmode",{nick:e.nick,text:p("client_models_network_mode",[n()]),channel:e.target}),"action mode"):console.log("MODE command recieved for unknown target %s: ",e.target,e)}function S(e){g.global.events.emit("whois",{nick:e.nick,network:this.gateway,whois:e}).then(function(){var t,n,i="";e.end||("undefined"!=typeof e.idle&&(i=s(parseInt(e.idle,10)),i=i.h.toString().lpad(2,"0")+":"+i.m.toString().lpad(2,"0")+":"+i.s.toString().lpad(2,"0")),n=g.app.panels().active,e.ident?n.addMsg(e.nick,u("whois_ident",{nick:e.nick,ident:e.ident,host:e.hostname,text:e.msg}),"whois"):e.chans?n.addMsg(e.nick,u("whois_channels",{nick:e.nick,text:p("client_models_network_channels",[e.chans])}),"whois"):e.irc_server?n.addMsg(e.nick,u("whois_server",{nick:e.nick,text:p("client_models_network_server",[e.irc_server,e.server_info])}),"whois"):e.msg?n.addMsg(e.nick,u("whois",{text:e.msg}),"whois"):e.logon?(t=new Date,t.setTime(1e3*e.logon),t=g.utils.formatDate(t),n.addMsg(e.nick,u("whois_idle_and_signon",{nick:e.nick,text:p("client_models_network_idle_and_signon",[i,t])}),"whois")):e.away_reason?n.addMsg(e.nick,u("whois_away",{nick:e.nick,text:p("client_models_network_away",[e.away_reason])}),"whois"):n.addMsg(e.nick,u("whois_idle",{nick:e.nick,text:p("client_models_network_idle",[i])}),"whois"))})}function T(e){var t;e.end||(t=g.app.panels().active,e.hostname?t.addMsg(e.nick,u("who",{nick:e.nick,ident:e.ident,host:e.hostname,realname:e.real_name,text:e.msg}),"whois"):t.addMsg(e.nick,u("whois_notfound",{nick:e.nick,text:p("client_models_network_nickname_notfound",[])}),"whois"))}function N(e){$.each(this.panels.models,function(t,n){n.isChannel()&&(member=n.get("members").getByNick(e.nick),member&&member.set("away",!!e.reason))})}function B(e){var t=g.model.Applet.loadOnce("kiwi_chanlist");t.view.show()}function D(e){var n,i;switch(e.channel===t||(n=this.panels.getByName(e.channel))||(n=this.panels.server),e.error){case"banned_from_channel":n.addMsg(" ",u("channel_banned",{nick:e.nick,text:p("client_models_network_banned",[e.channel,e.reason]),channel:e.channel}),"status"),g.app.message.text(g.global.i18n.translate("client_models_network_banned").fetch(e.channel,e.reason));break;case"bad_channel_key":n.addMsg(" ",u("channel_badkey",{nick:e.nick,text:p("client_models_network_channel_badkey",[e.channel]),channel:e.channel}),"status"),g.app.message.text(g.global.i18n.translate("client_models_network_channel_badkey").fetch(e.channel));break;case"invite_only_channel":n.addMsg(" ",u("channel_inviteonly",{nick:e.nick,text:p("client_models_network_channel_inviteonly",[e.nick,e.channel]),channel:e.channel}),"status"),g.app.message.text(e.channel+" "+g.global.i18n.translate("client_models_network_channel_inviteonly").fetch());break;case"user_on_channel":n.addMsg(" ",u("channel_alreadyin",{nick:e.nick,text:p("client_models_network_channel_alreadyin"),channel:e.channel}));break;case"channel_is_full":n.addMsg(" ",u("channel_limitreached",{nick:e.nick,text:p("client_models_network_channel_limitreached",[e.channel]),channel:e.channel}),"status"),g.app.message.text(e.channel+" "+g.global.i18n.translate("client_models_network_channel_limitreached").fetch(e.channel));break;case"chanop_privs_needed":n.addMsg(" ",u("chanop_privs_needed",{text:e.reason,channel:e.channel}),"status"),g.app.message.text(e.reason+" ("+e.channel+")");break;case"cannot_send_to_channel":n.addMsg(" ","== "+e.reason,"status");break;case"no_such_nick":i=this.panels.getByName(e.nick),i?i.addMsg(" ",u("no_such_nick",{nick:e.nick,text:e.reason,channel:e.channel}),"status"):this.panels.server.addMsg(" ",u("no_such_nick",{nick:e.nick,text:e.reason,channel:e.channel}),"status");break;case"nickname_in_use":this.panels.server.addMsg(" ",u("nickname_alreadyinuse",{nick:e.nick,text:p("client_models_network_nickname_alreadyinuse",[e.nick]),channel:e.channel}),"status"),this.panels.server!==this.panels.active&&g.app.message.text(g.global.i18n.translate("client_models_network_nickname_alreadyinuse").fetch(e.nick)),"none"!==g.app.controlbox.$el.css("display")&&(new g.view.NickChangeBox).render();break;case"password_mismatch":this.panels.server.addMsg(" ",u("channel_badpassword",{nick:e.nick,text:p("client_models_network_badpassword",[]),channel:e.channel}),"status");break;case"error":e.reason&&this.panels.server.addMsg(" ",u("general_error",{
text:e.reason}),"status")}}function I(e){var t=_.clone(e.params);t[0]&&t[0]==this.get("nick")&&t.shift(),this.panels.server.addMsg("",u("unknown_command",{text:"["+e.command+"] "+t.join(", ","")}))}function L(e){var t=g.app.panels().active;this.panels.server.addMsg("["+(e.nick||"")+"]",u("wallops",{text:e.msg}),"wallops",{time:e.time}),t!==this.panels.server&&(t.isChannel()||t.isQuery())&&t.get("network")===this&&t.addMsg("["+(e.nick||"")+"]",u("wallops",{text:e.msg}),"wallops",{time:e.time})}g.model.Network=Backbone.Model.extend({defaults:{connection_id:0,name:"Network",address:"",port:6667,ssl:!1,password:"",nick:"",channel_prefix:"#",user_prefixes:[{symbol:"~",mode:"q"},{symbol:"&",mode:"a"},{symbol:"@",mode:"o"},{symbol:"%",mode:"h"},{symbol:"+",mode:"v"}]},initialize:function(){"undefined"!=typeof this.get("connection_id")&&(this.gateway=g.global.components.Network(this.get("connection_id")),this.bindGatewayEvents()),this.panels=new g.model.PanelList([],this);var e=new g.model.Server({name:"Server",network:this});this.panels.add(e),this.panels.server=this.panels.active=e,this.ignore_list=new g.model.IgnoreList},reconnect:function(e){var t=this,n={nick:this.get("nick"),host:this.get("address"),port:this.get("port"),ssl:this.get("ssl"),password:this.get("password")};g.gateway.makeIrcConnection(n,function(n,i){n?(console.log("_kiwi.gateway.socket.on('error')",{reason:n}),e&&e(n)):(t.gateway.dispose(),t.set("connection_id",i),t.gateway=g.global.components.Network(t.get("connection_id")),t.bindGatewayEvents(),t.panels.forEach(function(e){e.set("connection_id",i)}),e&&e(n))})},bindGatewayEvents:function(){this.gateway.on("connect",n,this),this.gateway.on("disconnect",e,this),this.gateway.on("nick",function(e){e.nick===this.get("nick")&&this.set("nick",e.newnick)},this),this.gateway.on("options",i,this),this.gateway.on("motd",a,this),this.gateway.on("channel:join",o,this),this.gateway.on("channel:part",c,this),this.gateway.on("channel:kick",r,this),this.gateway.on("quit",l,this),this.gateway.on("message",h,this),this.gateway.on("nick",d,this),this.gateway.on("ctcp_request",f,this),this.gateway.on("ctcp_response",v,this),this.gateway.on("topic",w,this),this.gateway.on("topicsetby",k,this),this.gateway.on("userlist",y,this),this.gateway.on("userlist_end",x,this),this.gateway.on("banlist",C,this),this.gateway.on("mode",M,this),this.gateway.on("whois",S,this),this.gateway.on("whowas",T,this),this.gateway.on("away",N,this),this.gateway.on("list_start",B,this),this.gateway.on("irc_error",D,this),this.gateway.on("unknown_command",I,this),this.gateway.on("channel_info",b,this),this.gateway.on("wallops",L,this)},createAndJoinChannels:function(e){var n=this,i=[];return"string"==typeof e&&(e=e.split(",")),$.each(e,function(e,s){var a=s.trim().split(" "),o=a[0],c=a[1]||"";o=o.trim(),n.get("channel_prefix").indexOf(o[0])===-1&&(o="#"+o),channel=n.panels.getByName(o),channel||(channel=new g.model.Channel({name:o,network:n,key:c||t}),n.panels.add(channel)),i.push(channel),n.gateway.join(o,c)}),i},rejoinAllChannels:function(){var e=this;this.panels.forEach(function(n){n.isChannel()&&e.gateway.join(n.get("name"),n.get("key")||t)})},isChannelName:function(e){var t=this.get("channel_prefix");return!(!e||!e.length)&&t.indexOf(e[0])>-1},isUserIgnored:function(e){var t;return"object"==typeof e?e=(e.nick||"*")+"!"+(e.ident||"*")+"@"+(e.hostname||"*"):"string"==typeof e&&(e=m(e)),t=this.ignore_list.find(function(t){return t.get("regex").test(e)}),!!t},createQuery:function(e){var t,n=this;return t=n.panels.getByName(e),t||(t=new g.model.Query({name:e,network:this}),n.panels.add(t)),t.view.show(),t}})}(),g.model.Member=Backbone.Model.extend({initialize:function(e){var t,n;t=this.stripPrefix(this.get("nick")),n=this.get("modes"),n=n||[],this.sortModes(n),this.set({nick:t,modes:n,prefix:this.getPrefix(n)},{silent:!0}),this.updateOpStatus(),this.view=new g.view.Member({model:this})},sortModes:function(e){var t=this;return e.sort(function(e,n){var i,s,a,o=t.get("user_prefixes");for(a=0;a<o.length;a++)o[a].mode===e&&(i=a);for(a=0;a<o.length;a++)o[a].mode===n&&(s=a);return i<s?-1:i>s?1:0})},addMode:function(e){var t,n=e.split("");t=this.get("modes"),$.each(n,function(e,n){t.push(n)}),t=this.sortModes(t),this.set({prefix:this.getPrefix(t),modes:t}),this.updateOpStatus(),this.view.render()},removeMode:function(e){var t,n=e.split("");t=this.get("modes"),t=_.reject(t,function(e){return _.indexOf(n,e)!==-1}),this.set({prefix:this.getPrefix(t),modes:t}),this.updateOpStatus(),this.view.render()},getPrefix:function(e){var t="",n=this.get("user_prefixes");return"undefined"!=typeof e[0]&&(t=_.detect(n,function(t){return t.mode===e[0]}),t=t?t.symbol:""),t},stripPrefix:function(e){var t,n,i,s,a=e,o=this.get("user_prefixes");t=0;e:for(n=0;n<e.length;n++){for(s=e.charAt(n),i=0;i<o.length;i++)if(s===o[i].symbol){t++;continue e}break}return a.substr(t)},displayNick:function(e){var t=this.get("nick");return e&&this.get("ident")&&(t+=" ["+this.get("ident")+"@"+this.get("hostname")+"]"),t},getMaskParts:function(){return{nick:this.get("nick")||"",ident:this.get("ident")||"",hostname:this.get("hostname")||""}},updateOpStatus:function(){var e,t,n=this.get("user_prefixes"),i=this.get("modes");i.length>0?(e=_.indexOf(n,_.find(n,function(e){return"o"===e.mode})),t=_.indexOf(n,_.find(n,function(e){return e.mode===i[0]})),t===-1||t>e?this.set({is_op:!1},{silent:!0}):this.set({is_op:!0},{silent:!0})):this.set({is_op:!1},{silent:!0})}}),g.model.MemberList=Backbone.Collection.extend({model:g.model.Member,comparator:function(e,t){var n,i,s,a,o,c,l,r=this.channel.get("network").get("user_prefixes");if(i=e.get("modes"),s=t.get("modes"),i.length>0){if(0===s.length)return-1;for(a=o=-1,n=0;n<r.length;n++)r[n].mode===i[0]&&(a=n);for(n=0;n<r.length;n++)r[n].mode===s[0]&&(o=n);if(a<o)return-1;if(a>o)return 1}else if(s.length>0)return 1;return c=e.get("nick").toLocaleLowerCase(),l=t.get("nick").toLocaleLowerCase(),c<l?-1:c>l?1:0},initialize:function(e){this.view=new g.view.MemberList({model:this}),this.initNickCache()},initNickCache:function(){function e(e){return e.get("nick").toLowerCase()}var t=_.bind(function(){var e="a-z0-9_\\-{}[\\]^`|\\\\",t=Object.keys(this.nick_cache).map(_.escapeRegExp).join("|");this.nick_regex=new RegExp("^[^"+e+"]?("+t+")[^"+e+"]?$","i")},this);this.nick_cache=Object.create(null),this.nick_regex=null,this.on("reset",function(){this.nick_cache=_.reduce(this.models,function(t,n){return t[e(n)]=n,t},Object.create(null)),t()}),this.on("add",function(n){this.nick_cache[e(n)]=n,t()}),this.on("remove",function(n){delete this.nick_cache[e(n)],t()}),this.on("change:nick",function(n){this.nick_cache[e(n)]=n,delete this.nick_cache[n.previous("nick").toLowerCase()],t()})},getByNick:function(e){var t;if(this.nick_regex&&(t=this.nick_regex.exec(e)))return this.nick_cache[t[1].toLowerCase()]}}),g.model.IgnoreList=Backbone.Collection.extend({initialize:function(){this.network_address="",this.ignore_data=g.model.DataStore.instance("kiwi.ignore_list"),this.ignore_data.load(),this.on("add",_.bind(this.onAdd,this)),this.on("add",_.bind(this.saveList,this)),this.on("remove",_.bind(this.saveList,this))},onAdd:function(e){e.get("mask")&&(e.get("time")||e.set("time",(new Date).getTime()),e.get("regex")||e.set("regex",m(e.get("mask"),!0)[1]))},loadFromNetwork:function(e){this.network_address=e.get("address").toLowerCase();var t=this.ignore_data.get(this.network_address)||[];_.each(t,function(e,t){e&&e.mask&&(e.regex=m(e.mask,!0)[1])}),this.reset(t)},saveList:function(){var e=[];this.forEach(function(t){var n=_.clone(t.attributes);delete n.regex,e.push(n)}),this.ignore_data.set(this.network_address,e),this.ignore_data.save()},addMask:function(e){return this.add({mask:e})},removeMask:function(e){var t=this.find(function(t){return t.get("mask")==e});t&&this.remove(t)}}),g.model.NewConnection=Backbone.Collection.extend({initialize:function(){this.view=new g.view.ServerSelect({model:this}),this.view.bind("server_connect",this.onMakeConnection,this)},populateDefaultServerSettings:function(){var e=g.global.defaultServerSettings();this.view.populateFields(e)},onMakeConnection:function(e){var t=this;this.connect_details=e,this.view.networkConnecting(),g.gateway.newConnection({nick:e.nick,host:e.server,port:e.port,ssl:e.ssl,password:e.password,options:e.options},function(e,n){t.onNewNetwork(e,n)})},onNewNetwork:function(e,t){e&&this.view.showError(e),t&&this.connect_details&&(t.auto_join={channel:this.connect_details.channel,key:this.connect_details.channel_key},this.trigger("new_network",t))}}),g.model.Panel=Backbone.Model.extend({initialize:function(e){var t=this.get("name")||"";this.view=new g.view.Panel({model:this,name:t}),this.set({scrollback:[],name:t},{silent:!0}),g.global.events.emit("panel:created",{panel:this})},close:function(){g.app.panels.trigger("close",this),g.global.events.emit("panel:close",{panel:this}),this.view&&(this.view.unbind(),this.view.remove(),this.view=t,delete this.view);var e=this.get("members");e&&(e.reset([]),this.unset("members")),this.get("panel_list").remove(this),this.unbind(),this.destroy()},isChannel:function(){return!1},isQuery:function(){return!1},isApplet:function(){return!1},isServer:function(){return!1},isActive:function(){return g.app.panels().active===this}}),g.model.PanelList=Backbone.Collection.extend({model:g.model.Panel,comparator:function(e){return e.get("name")},initialize:function(e,t){t&&(this.network=t),this.view=new g.view.Tabs({model:this}),this.active=null,this.bind("active",function(e){this.active=e},this),this.bind("add",function(e){e.set("panel_list",this)})},getByCid:function(e){if("string"==typeof name)return this.find(function(t){return e===t.cid})},getByName:function(e){if("string"==typeof e)return this.find(function(t){return e.toLowerCase()===t.get("name").toLowerCase()})}}),g.model.NetworkPanelList=Backbone.Collection.extend({model:g.model.Network,initialize:function(){this.view=new g.view.NetworkTabs({model:this}),this.on("add",this.onNetworkAdd,this),this.on("remove",this.onNetworkRemove,this),this.active_connection=t,this.active_panel=t,this.active=t},getByConnectionId:function(e){return this.find(function(t){return t.get("connection_id")==e})},panels:function(){var e=[];return this.each(function(t){e=e.concat(t.panels.models)}),e},onNetworkAdd:function(e){e.panels.on("active",this.onPanelActive,this),1===this.models.length&&(this.active_connection=e,this.active_panel=e.panels.server,this.active=this.active_panel)},onNetworkRemove:function(e){e.panels.off("active",this.onPanelActive,this)},onPanelActive:function(e){var t=this.getByConnectionId(e.tab.data("connection_id"));this.trigger("active",e,t),this.active_connection=t,this.active_panel=e,this.active=e}}),g.model.Channel=g.model.Panel.extend({initialize:function(e){var t,n=this.get("name")||"";this.set({members:new g.model.MemberList,name:n,scrollback:[],topic:""},{silent:!0}),this.view=new g.view.Channel({model:this,name:n}),t=this.get("members"),t.channel=this,t.bind("add",function(e,t,i){var s=g.global.settings.get("show_joins_parts");s!==!1&&this.addMsg(" ",u("channel_join",{member:e.getMaskParts(),text:p("client_models_channel_join"),channel:n}),"action join",{time:i.kiwi.time})},this),t.bind("remove",function(e,t,i){var s=g.global.settings.get("show_joins_parts"),a=i.kiwi.message?"("+i.kiwi.message+")":"";"quit"===i.kiwi.type&&s?this.addMsg(" ",u("channel_quit",{member:e.getMaskParts(),text:p("client_models_channel_quit",[a]),channel:n}),"action quit",{time:i.kiwi.time}):"kick"===i.kiwi.type?i.kiwi.current_user_kicked?this.addMsg(" ",u("channel_selfkick",{text:p("client_models_channel_selfkick",[i.kiwi.by,a]),channel:n}),"action kick",{time:i.kiwi.time}):(s||i.kiwi.current_user_initiated)&&this.addMsg(" ",u("channel_kicked",{member:e.getMaskParts(),text:p("client_models_channel_kicked",[i.kiwi.by,a]),channel:n}),"action kick",{time:i.kiwi.time}):s&&this.addMsg(" ",u("channel_part",{member:e.getMaskParts(),text:p("client_models_channel_part",[a]),channel:n}),"action part",{time:i.kiwi.time})},this),g.global.events.emit("panel:created",{panel:this})},addMsg:function(e,t,n,i){var s,a,o,c,l=parseInt(g.global.settings.get("scrollback"),10)||250;i=i||{},"number"==typeof i.time?i.time=new Date(i.time):i.time=new Date,i&&"undefined"!=typeof i.style||(i.style=""),s={msg:t,date:i.date,time:i.time,nick:e,chan:this.get("name"),type:n,style:i.style},o=this.get("members"),o&&(c=o.getByNick(s.nick),c&&(s.nick_prefix=c.get("prefix"))),"string"!=typeof s.type&&(s.type=""),"string"!=typeof s.msg&&(s.msg=""),a=this.get("scrollback"),a&&(a.push(s),a.length>l&&(a=_.takeRight(a,l)),this.set({scrollback:a},{silent:!0})),this.trigger("msg",s)},clearMessages:function(){this.set({scrollback:[]},{silent:!0}),this.addMsg("","Window cleared"),this.view.render()},setMode:function(e){this.get("network").gateway.mode(this.get("name"),e)},isChannel:function(){return!0}}),g.model.Query=g.model.Channel.extend({initialize:function(e){var t=this.get("name")||"";this.view=new g.view.Channel({model:this,name:t}),this.set({name:t,scrollback:[]},{silent:!0}),g.global.events.emit("panel:created",{panel:this})},isChannel:function(){return!1},isQuery:function(){return!0}}),g.model.Server=g.model.Channel.extend({initialize:function(e){var t="Server";this.view=new g.view.Channel({model:this,name:t}),this.set({scrollback:[],name:t},{silent:!0}),g.global.events.emit("panel:created",{panel:this})},isServer:function(){return!0},isChannel:function(){return!1}}),g.model.Applet=g.model.Panel.extend({initialize:function(e){var t="applet_"+(new Date).getTime().toString()+Math.ceil(100*Math.random()).toString();this.view=new g.view.Applet({model:this,name:t}),this.set({name:t},{silent:!0}),this.loaded_applet=null},load:function(e,t){return"object"==typeof e?(e.get||e.extend)&&(this.set("title",e.get("title")||g.global.i18n.translate("client_models_applet_unknown").fetch()),e.bind("change:title",function(e,t){this.set("title",t)},this),this.view.$el.html(""),e.view&&this.view.$el.append(e.view.$el),this.loaded_applet=e,this.loaded_applet.trigger("applet_loaded")):"string"==typeof e&&this.loadFromUrl(e,t),this},loadFromUrl:function(e,t){var n=this;this.view.$el.html(g.global.i18n.translate("client_models_applet_loading").fetch()),$script(e,function(){return g.applets[t]?void n.load(new g.applets[t]):void n.view.$el.html(g.global.i18n.translate("client_models_applet_notfound").fetch())})},close:function(){this.view.$el.remove(),this.destroy(),this.view=t,this.loaded_applet&&this.loaded_applet.dispose&&this.loaded_applet.dispose(),this.constructor.__super__.close.apply(this,arguments)},isApplet:function(){return!0}},{loadOnce:function(e){var t=_.find(g.app.panels("applets"),function(t){if(t.isApplet()&&t.loaded_applet)return t.loaded_applet.get("_applet_name")===e||void 0});return t?t:this.load(e)},load:function(e,t){var n,i;if(t=t||{},i=this.getApplet(e))return n=new g.model.Applet,n.load(new i({_applet_name:e})),t.no_tab||g.app.applet_panels.add(n),n},getApplet:function(e){return g.applets[e]||null},register:function(e,t){g.applets[e]=t}}),g.model.PluginManager=Backbone.Model.extend({initialize:function(){this.$plugin_holder=$('<div id="kiwi_plugins" style="display:none;"></div>').appendTo(g.app.view.$el),this.loading_plugins=0,this.loaded_plugins={}},load:function(e){var t=this;this.loaded_plugins[e]&&this.unload(e),this.loading_plugins++,this.loaded_plugins[e]=$("<div></div>"),this.loaded_plugins[e].appendTo(this.$plugin_holder).load(e,_.bind(t.pluginLoaded,t))},unload:function(e){this.loaded_plugins[e]&&(this.loaded_plugins[e].remove(),delete this.loaded_plugins[e])},pluginLoaded:function(){this.loading_plugins--,0===this.loading_plugins&&this.trigger("loaded")}}),g.model.DataStore=Backbone.Model.extend({initialize:function(){this._namespace="",this.new_data={},this.stored_attributes={}},namespace:function(e){return e&&(this._namespace=e),this._namespace},save:function(){var e=JSON.stringify(this.attributes);localStorage.setItem(this._namespace,e),this.stored_attributes=JSON.parse(e)},saveOne:function(e){this.stored_attributes[e]=this.get(e),localStorage.setItem(this._namespace,JSON.stringify(this.stored_attributes))},load:function(){if(localStorage){var e,t,n;try{e=localStorage.getItem(this._namespace),t=JSON.parse(e)||{},n=JSON.parse(e)||{}}catch(e){t={},n={}}this.attributes=t,this.stored_attributes=n}}},{instance:function(e,t){var n=new g.model.DataStore(t);return n.namespace(e),n}}),g.model.ChannelInfo=Backbone.Model.extend({initialize:function(){this.view=new g.view.ChannelInfo({model:this})}}),g.view.Panel=Backbone.View.extend({tagName:"div",className:"panel",events:{},initialize:function(e){this.initializePanel(e)},initializePanel:function(e){this.$el.css("display","none"),e=e||{},e.container?this.$container=$(e.container):this.$container=$("#kiwi .panels .container1"),this.$el.appendTo(this.$container),this.alert_level=0,this.model.set({view:this},{silent:!0}),this.listenTo(this.model,"change:activity_counter",function(e,t){var n=this.model.tab.find(".activity");t>999?n.text("999+"):n.text(t),0===t?n.addClass("zero"):n.removeClass("zero")})},render:function(){},show:function(){var e=this.$el;this.$container.children(".panel").css("display","none"),e.css("display","block");var t=this.model.get("members");t?(g.app.rightbar.show(),t.view.show()):g.app.rightbar.hide(),this.alert("none"),this.model.set("activity_counter",0),g.app.panels.trigger("active",this.model,g.app.panels().active),this.model.trigger("active",this.model),g.app.view.doLayout(),this.model.isApplet()||this.scrollToBottom(!0)},alert:function(e){if(this.model!=g.app.panels().active){var t,n;t=["none","action","activity","highlight"],e=e||"none",n=_.indexOf(t,e),n||(e="none",n=0),0!==n&&n<=this.alert_level||(this.model.tab.removeClass(function(e,t){return(t.match(/\balert_\S+/g)||[]).join(" ")}),"none"!==e&&this.model.tab.addClass("alert_"+e),this.alert_level=n)}},scrollToBottom:function(e){this.model===g.app.panels().active&&(e||this.$container.scrollTop()+this.$container.height()>this.$el.outerHeight()-150)&&(this.$container[0].scrollTop=this.$container[0].scrollHeight)}}),g.view.Channel=g.view.Panel.extend({events:function(){var e=this.constructor.__super__.events;return _.isFunction(e)&&(e=e()),_.extend({},e,{"click .msg .nick":"nickClick","click .msg .inline-nick":"nickClick","contextmenu .msg .nick":"nickClick","contextmenu .msg .inline-nick":"nickClick","dblclick .msg .nick":"nickClick","dblclick .msg .inline-nick":"nickClick","click .chan":"chanClick","click .media .open":"mediaClick","mouseenter .msg .nick":"msgEnter","mouseleave .msg .nick":"msgLeave"})},initialize:function(e){this.initializePanel(e),this.$messages=$('<div class="messages"></div>'),this.$el.append(this.$messages),this.model.bind("change:topic",this.topic,this),this.model.bind("change:topic_set_by",this.topicSetBy,this),this.model.get("members")&&(this.model.get("members").bind("add",function(e){e.get("nick")===this.model.collection.network.get("nick")&&this.$el.find(".initial_loader").slideUp(function(){$(this).remove()})},this),this.model.get("members").bind("reset",function(e){e.getByNick(this.model.collection.network.get("nick"))&&this.$el.find(".initial_loader").slideUp(function(){$(this).remove()})},this)),this.model.isChannel()&&this.$el.append('<div class="initial_loader" style="margin:1em;text-align:center;"> '+g.global.i18n.translate("client_views_channel_joining").fetch()+' <span class="loader"></span></div>'),this.listenTo(g.app.panels,"active",function(e,t){t===this.model&&this.updateLastSeenMarker()}),this.model.bind("msg",this.newMsg,this),this.msg_count=0},render:function(){var e=this;this.$messages.empty(),_.each(this.model.get("scrollback"),function(t){e.newMsg(t)})},newMsg:function(e){e=this.generateMessageDisplayObj(e),g.global.events.emit("message:display",{panel:this.model,message:e}).then(_.bind(function(){var t,n=_.clone(e);n.nick=u("message_nick",{nick:e.nick,prefix:e.nick_prefix||""}),t='<div class="msg <%= type %> <%= css_classes %>"><div class="time"><%- time_string %></div><div class="nick" style="<%= nick_style %>"><%- nick %></div><div class="text" style="<%= style %>"><%= msg %> </div></div>',this.$messages.append($(_.template(t)(n)).data("message",e)),this.model.get("network")&&(e.type.match(/^action /)?this.alert("action"):e.is_highlight?(g.app.view.alertWindow("* "+g.global.i18n.translate("client_views_panel_activity").fetch()),g.app.view.favicon.newHighlight(),g.app.view.playSound("highlight"),g.app.view.showNotification(this.model.get("name"),e.unparsed_msg),this.alert("highlight")):(this.model.isActive()&&g.app.view.alertWindow("* "+g.global.i18n.translate("client_views_panel_activity").fetch()),this.alert("activity")),this.model.isQuery()&&!this.model.isActive()&&(g.app.view.alertWindow("* "+g.global.i18n.translate("client_views_panel_activity").fetch()),e.is_highlight||g.app.view.favicon.newHighlight(),g.app.view.showNotification(this.model.get("name"),e.unparsed_msg),g.app.view.playSound("highlight")),function(){if(!this.model.isActive()){var t,n,i=g.global.settings.get("count_all_activity");"undefined"==typeof i&&(i=!1),t=["action join","action quit","action part","action kick","action nick","action mode"],(i||_.indexOf(t,e.type)===-1)&&(n=this.model.get("activity_counter")||0,n++,this.model.set("activity_counter",n))}}.apply(this)),this.model.isActive()&&this.scrollToBottom(),this.msg_count++,this.msg_count>(parseInt(g.global.settings.get("scrollback"),10)||250)&&($(".msg:first",this.$messages).remove(),this.msg_count--)},this))},parseMessageNicks:function(e,t){var n,i,s,a,o="";if((n=this.model.get("members"))&&(i=n.getByNick(e)))return s=i.get("nick"),t!==!1&&(o=this.getNickStyles(s).asCssString()),a=new RegExp("(.*)("+_.escapeRegExp(s)+")(.*)","i"),e.replace(a,function(e,t,n,i){return _.escape(t)+'<span class="inline-nick" style="'+o+'; cursor:pointer" data-nick="'+_.escape(s)+'">'+_.escape(n)+"</span>"+_.escape(i)})},parseMessageChannels:function(e){var t,n=!1,i=this.model.get("network");if(i)return t=new RegExp("(^|\\s)(["+_.escapeRegExp(i.get("channel_prefix"))+"][^ .,\\007]+)","g"),e.match(t)?n=e.replace(t,function(e,t){return t+'<a class="chan" data-channel="'+_.escape(e.trim())+'">'+_.escape(e.trim())+"</a>"}):n},parseMessageUrls:function(e){var t,n=!1;return t=e.replace(/^(([A-Za-z][A-Za-z0-9\-]*\:\/\/)|(www\.))([\w\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF.\-]+)([a-zA-Z]{2,6})(:[0-9]+)?(\/[\w\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF!:.?$'()[\]*,;~+=&%@!\-\/]*)?(#.*)?$/gi,function(e){var t=e,i="";return e.match(/^javascript:/i)?e:(n=!0,e.match(/^www\./i)&&(e="http://"+e),t.length>100&&(t=t.substr(0,100)+"..."),i=g.view.MediaMessage.buildHtml(e),'<a class="link_ext" target="_blank" rel="nofollow" href="'+e.replace(/"/g,"%22")+'">'+_.escape(t)+"</a>"+i)}),!!n&&t},getNickStyles:function(){function e(e,t,n){return e+("string"==typeof t||"number"==typeof t?n+":"+t+";":"")}function t(){return _.reduce(this,e,"")}function n(e,t){return e+t.charCodeAt(0)}return function(e){var i,s,a;return i=(_.find(g.app.themes,function(e){return e.name.toLowerCase()===g.global.settings.get("theme").toLowerCase()})||{}).nick_lightness,i="number"!=typeof i?35:Math.max(0,Math.min(100,i)),s=_.reduce(e.split(""),n,0),a=o(s%256,70,i),{color:"#"+("000000"+(a[2]|a[1]<<8|a[0]<<16).toString(16)).substr(-6),asCssString:t}}}(),generateMessageDisplayObj:function(e){var t,n,i,s,a,o,c,r,d=this.model.get("scrollback"),u=this.model.get("network"),m=d[d.length-2];return e=_.clone(e),e.css_classes="",e.nick_style="",e.is_highlight=!1,e.time_string="",s=u?u.get("nick"):"",s&&0!==e.nick.localeCompare(s)&&(a=_.chain((g.global.settings.get("custom_highlights")||"").split(/[\s,]+/)).compact().concat(s).map(_.escapeRegExp).join("|").value(),e.msg.search(new RegExp("(\\b|\\W|^)("+a+")(\\b|\\W|$)","i"))>-1&&(e.is_highlight=!0,e.css_classes+=" highlight")),i=e.msg.split(" "),i=_.map(i,function(t){var n;return n=this.parseMessageUrls(t),"string"==typeof n?n:(n=this.parseMessageChannels(t),"string"==typeof n?n:(n=this.parseMessageNicks(t,"privmsg"===e.type),"string"==typeof n?n:(n=_.escape(t),g.global.settings.get("show_emoticons")&&(n=h(n)),n)))},this),e.unparsed_msg=e.msg,e.msg=i.join(" "),e.msg=l(e.msg),e.nick_style=this.getNickStyles(e.nick).asCssString(),t="",e.nick&&(_.map(e.nick.split(""),function(e){t+=e.charCodeAt(0).toString(16)}),e.css_classes+=" nick_"+t),m&&(n=(e.time.getTime()-m.time.getTime())/1e3/60,m.nick===e.nick&&n<1&&(e.css_classes+=" repeated_nick")),g.global.settings.get("use_24_hour_timestamps")?e.time_string=e.time.getHours().toString().lpad(2,"0")+":"+e.time.getMinutes().toString().lpad(2,"0")+":"+e.time.getSeconds().toString().lpad(2,"0"):(o=e.time.getHours(),c=o>11,o%=12,0===o&&(o=12),r=c?"client_views_panel_timestamp_pm":"client_views_panel_timestamp_am",e.time_string=p(r,o+":"+e.time.getMinutes().toString().lpad(2,"0")+":"+e.time.getSeconds().toString().lpad(2,"0"))),e},topic:function(e){"string"==typeof e&&e||(e=this.model.get("topic")),this.model.addMsg("",u("channel_topic",{text:e,channel:this.model.get("name")}),"topic"),g.app.panels().active===this.model&&g.app.topicbar.setCurrentTopicFromChannel(this.model)},topicSetBy:function(e){g.app.panels().active===this.model&&g.app.topicbar.setCurrentTopicFromChannel(this.model)},nickClick:function(e){var t,n,i=$(e.currentTarget),s=this.model.get("members");e.stopPropagation(),t=i.data("nick"),t||(t=i.parent(".msg").data("message").nick),n=s?s.getByNick(t):null,n&&g.global.events.emit("nick:select",{target:i,member:n,network:this.model.get("network"),source:"message",$event:e}).then(_.bind(this.openUserMenuForNick,this,i,n))},updateLastSeenMarker:function(){this.$(".last_seen").removeClass("last_seen"),this.$messages.children().last().addClass("last_seen")},openUserMenuForNick:function(e,t){var n,i,s=this.model.get("members"),a=this.model.get("network"),o=!!a&&!!s.getByNick(a.get("nick")).get("is_op");a&&(n=new g.view.UserBox,n.setTargets(t,this.model),n.displayOpItems(o),i=new g.view.MenuBox(t.get("nick")||"User"),i.addItem("userbox",n.$el),i.showFooter(!1),g.global.events.emit("usermenu:created",{menu:i,userbox:n,user:t}).then(_.bind(function(){i.show();var t=e.offset(),n=t.top,s=n+i.$el.outerHeight(),a=this.$el.parent().offset().top+this.$el.parent().outerHeight();s>a&&(n=a-i.$el.outerHeight()),i.$el.offset({left:t.left,top:n})},this)).then(null,_.bind(function(){n=null,menu.dispose(),menu=null},this)))},chanClick:function(e){var t=e.target?$(e.target).data("channel"):$(e.srcElement).data("channel");this.model.get("network").gateway.join(t)},mediaClick:function(e){var t,n=$(e.target).parents(".media");n.data("media")?t=n.data("media"):(t=new g.view.MediaMessage({el:n[0]}),n.data("media",t)),t.toggle()},msgEnter:function(e){var t;_.each($(e.currentTarget).parent(".msg").attr("class").split(" "),function(e){e.match(/^nick_[a-z0-9]+/i)&&(t=e)}),t&&$("."+t).addClass("global_nick_highlight")},msgLeave:function(e){var t;_.each($(e.currentTarget).parent(".msg").attr("class").split(" "),function(e){e.match(/^nick_[a-z0-9]+/i)&&(t=e)}),t&&$("."+t).removeClass("global_nick_highlight")}}),g.view.Applet=g.view.Panel.extend({className:"panel applet",initialize:function(e){this.initializePanel(e)}}),g.view.Application=Backbone.View.extend({initialize:function(){var e=this;this.$el=$($("#tmpl_application").html().trim()),this.el=this.$el[0],$(this.model.get("container")||"body").append(this.$el),this.elements={panels:this.$el.find(".panels"),right_bar:this.$el.find(".right_bar"),toolbar:this.$el.find(".toolbar"),controlbox:this.$el.find(".controlbox"),resize_handle:this.$el.find(".memberlists_resize_handle")},$(window).resize(function(){e.doLayout.apply(e)}),this.elements.toolbar.resize(function(){e.doLayout.apply(e)}),this.elements.controlbox.resize(function(){e.doLayout.apply(e)}),g.global.settings.on("change:theme",this.updateTheme,this),this.updateTheme(getQueryVariable("theme")),g.global.settings.on("change:channel_list_style",this.setTabLayout,this),this.setTabLayout(g.global.settings.get("channel_list_style")),g.global.settings.on("change:show_timestamps",this.displayTimestamps,this),this.displayTimestamps(g.global.settings.get("show_timestamps")),this.$el.appendTo($("body")),this.doLayout(),$(document).keydown(this.setKeyFocus),window.onbeforeunload=function(){if(g.gateway.isConnected())return g.global.i18n.translate("client_views_application_close_notice").fetch()},this.has_focus=!0,$(window).on("focus",function(){e.has_focus=!0}),$(window).on("blur",function(){var t=e.model.panels().active;t&&t.view.updateLastSeenMarker&&t.view.updateLastSeenMarker(),e.has_focus=!1}),$(window).on("touchstart",function t(){e.$el.addClass("touch"),$(window).off("touchstart",t)}),this.favicon=new g.view.Favicon,this.initSound(),this.monitorPanelFallback()},updateTheme:function(e){e===g.global.settings&&(e=arguments[1]),e||(e=g.global.settings.get("theme")||"relaxed"),e=e.toLowerCase(),$("[data-theme]").each(function(e,t){t.disabled=!0});var t=$("[data-theme][title="+e+"]");t.length>0&&(t[0].disabled=!1),this.doLayout()},reloadStyles:function(){var e="?reload="+(new Date).getTime();$('link[rel="stylesheet"]').each(function(){this.href=this.href.replace(/\?.*|$/,e)})},setTabLayout:function(e){e===g.global.settings&&(e=arguments[1]),"list"==e?this.$el.addClass("chanlist_treeview"):this.$el.removeClass("chanlist_treeview"),this.doLayout()},displayTimestamps:function(e){e===g.global.settings&&(e=arguments[1]),e?this.$el.addClass("timestamps"):this.$el.removeClass("timestamps")},setKeyFocus:function(e){if(!(e.ctrlKey||e.altKey||e.metaKey)){var t=["input","select","textarea","button","datalist","keygen"],n=t.indexOf(e.target.tagName.toLowerCase())>-1||$(e.target).attr("contenteditable");n||$("#kiwi .controlbox .inp").focus()}},doLayout:function(){var e=this.$el,t=this.elements.panels,n=this.elements.right_bar,i=this.elements.toolbar,s=this.elements.controlbox,a=this.elements.resize_handle;if(e.is(":visible")){var o={top:i.outerHeight(!0),bottom:s.outerHeight(!0)};i.is(":visible")||(o.top=0),s.is(":visible")||(o.bottom=0),t.css(o),n.css(o),a.css(o),e.hasClass("chanlist_treeview")&&this.$el.find(".tabs",e).css(o),e.outerWidth()<700?(e.addClass("narrow"),this.model.rightbar&&this.model.rightbar.keep_hidden!==!0&&this.model.rightbar.toggle(!0)):(e.removeClass("narrow"),this.model.rightbar&&this.model.rightbar.keep_hidden!==!1&&this.model.rightbar.toggle(!1)),n.hasClass("disabled")?(t.css("right",0),a.css("left",t.outerWidth(!0))):(t.css("right",n.outerWidth(!0)),a.css("left",n.position().left-a.outerWidth(!0)/2));var c=parseInt(s.find(".input_tools").outerWidth(),10);s.find(".input_wrap").css("right",c+7)}},alertWindow:function(e){this.alertWindowTimer||(this.alertWindowTimer=new function(){var e,t=this,n=!0,i=0,s=g.app.server_settings.client.window_title||"Kiwi IRC",a="Kiwi IRC";this.setTitle=function(e){return e=e||s,window.document.title=e,e},this.start=function(t){n||(a=t,e||(e=setInterval(this.update,1e3)))},this.stop=function(){e&&clearInterval(e),e=null,this.setTitle(),setTimeout(this.reset,2e3)},this.reset=function(){e||t.setTitle()},this.update=function(){0===i?(t.setTitle(a),i=1):(t.setTitle(),i=0)},$(window).focus(function(e){n=!0,t.stop(),setTimeout(t.reset,2e3)}),$(window).blur(function(e){n=!1})}),this.alertWindowTimer.start(e)},barsHide:function(e){e?(this.$el.find(".toolbar").slideUp(0),$("#kiwi .controlbox").slideUp(0),this.doLayout()):(this.$el.find(".toolbar").slideUp({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}),$("#kiwi .controlbox").slideUp({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}))},barsShow:function(e){e?(this.$el.find(".toolbar").slideDown(0),$("#kiwi .controlbox").slideDown(0),this.doLayout()):(this.$el.find(".toolbar").slideDown({queue:!1,duration:400,step:$.proxy(this.doLayout,this)}),$("#kiwi .controlbox").slideDown({queue:!1,duration:400,step:$.proxy(this.doLayout,this)
}))},initSound:function(){var e=this,t=this.model.get("base_path");$script(t+"/assets/libs/soundmanager2/soundmanager2-nodebug-jsmin.js",function(){"undefined"!=typeof soundManager&&soundManager.setup({url:t+"/assets/libs/soundmanager2/",flashVersion:9,preferFlash:!1,onready:function(){e.sound_object=soundManager.createSound({id:"highlight",url:t+"/assets/sound/highlight.mp3"})}})})},playSound:function(e){this.sound_object&&(g.global.settings.get("mute_sounds")||soundManager.play(e))},showNotification:function(e,t){var n=this.model.get("base_path")+"/assets/img/ico.png",i=g.utils.notifications;!this.has_focus&&i.allowed()&&i.create(e,{icon:n,body:t}).closeAfter(5e3).on("click",_.bind(window.focus,window))},monitorPanelFallback:function(){var e=[];this.model.panels.on("active",function(){var t,n=g.app.panels().active;t=_.indexOf(e,n.cid),t>-1&&e.splice(t,1),e.unshift(n.cid)}),this.model.panels.on("remove",function(t){if(e[0]===t.cid){e.shift();var n=_.find(g.app.panels("applets").concat(g.app.panels("connections")),{cid:e[0]});n&&n.view.show()}})}}),g.view.AppToolbar=Backbone.View.extend({events:{"click .settings":"clickSettings","click .startup":"clickStartup"},initialize:function(){g.app.server_settings.connection&&!g.app.server_settings.connection.allow_change&&this.$(".startup").css("display","none")},clickSettings:function(e){e.preventDefault(),g.app.controlbox.processInput("/settings")},clickStartup:function(e){e.preventDefault(),g.app.startup_applet.view.show()}}),g.view.ControlBox=Backbone.View.extend({events:{"keydown .inp":"inputKeyDown","keyup .inp":"inputKeyUp","blur .inp":"inputBlur","click .nick":"showNickChange"},initialize:function(){var e=this;this.buffer=[],this.buffer_pos=0,this.preprocessor=new a,this.preprocessor.recursive_depth=5,this.autocomplete=new f({el:this.$(".autocomplete")[0]}),this.autocomplete_command_list=[],this.bindAutocomplete(),g.app.connections.on("change:nick",function(t){t===g.app.connections.active_connection&&$(".nick",e.$el).text(t.get("nick"))}),g.app.connections.on("active",function(t,n){$(".nick",e.$el).text(n.get("nick"))})},render:function(){var e=p("client_views_controlbox_message");return this.$(".inp").attr("placeholder",e),this},bindAutocomplete:function(){this.listenTo(this.autocomplete,"match",function(e,t){var n="";"nick"===t.type&&0===this.autocomplete_token_idx&&(n=": "),this.autoCompleteFillWord(e+n,!0),this.autocomplete.close()}),this.listenTo(this.autocomplete,"selected",function(e,t){var n="";t&&"nick"===t.type&&0===this.autocomplete_token_idx&&(n=": "),this.autocomplete.filter_list||this.autoCompleteFillWord(e?e+n:this.autocomplete.matching_against_word,!0)});var e=!0;this.listenTo(this.autocomplete,"cancel",function(t){var n=this.$(".inp"),i=(n[0],n.val()),s=n.selectRange();if("typing"===t||"lost_focus"===t){var a=i.indexOf(" ",s);a===-1&&(a=i.length),n.val(i.substr(0,s)+i.substr(a+1,i.length))}else n.val(this.autocomplete_before.value);e="lost_focus"!==t,e&&n.selectRange(s),this.autocomplete.close()}),this.listenTo(this.autocomplete,"close",function(){e&&this.$(".inp").focus()}),this.listenTo(this.autocomplete,"action-message",function(e){g.app.connections.active_connection.createQuery(e),this.autocomplete.close(),this.$(".inp").val("")}),this.listenTo(this.autocomplete,"action-more",function(e){var t,n=g.app.panels().active,i=n.get("members"),s=i.getByNick(e),a=!!i.getByNick(g.app.connections.active_connection.get("nick")).get("is_op");t=new g.view.UserBox,t.setTargets(s,n),t.displayOpItems(a);var o=new g.view.MenuBox(s.get("nick")||"User");o.addItem("userbox",t.$el),o.showFooter(!1),g.global.events.emit("usermenu:created",{menu:o,userbox:t,user:s}).then(_.bind(function(){o.show();var e=g.app.view.$el.height()-this.autocomplete.$el.outerHeight()-o.$el.outerHeight(),t=g.app.view.$el.width()-o.$el.outerWidth();o.$el.offset({left:t,top:e})},this)).then(null,_.bind(function(){t=null,o.dispose(),o=null},this))})},autoCompleteFillWord:function(e,t){var n=this.$(".inp"),i=n.val(),s=n[0].selectionStart,a=": "===i.substr(s-2,2),o=i.lastIndexOf(" ",s-(a?2:1));o=o===-1?0:o+1;var c=i.indexOf(" ",o);c===-1&&(c=i.length);var l=i.substr(0,o),r=i.substr(c),h=l+e+r;n.val(h);var d=o+this.autocomplete.matching_against_word.length;t&&(d=o+e.length),n[0].setSelectionRange?n[0].setSelectionRange(d,d):n[0].createTextRange&&(range=n[0].createTextRange(),range.collapse(!0),range.moveEnd("character",d),range.moveStart("character",d),range.select())},showNickChange:function(e){this.nick_change||(this.nick_change=new g.view.NickChangeBox,this.nick_change.render(),this.listenTo(this.nick_change,"close",function(){delete this.nick_change}))},inputKeyUp:function(e){if(this.autocomplete.open&&this.autocomplete.filter_list){var t=$(e.currentTarget),n=t.val().trim().substring(0,t[0].selectionStart).split(" ");this.autocomplete.update(n[n.length-1])}},inputKeyDown:function(e){var t,n=this,i=$(e.currentTarget),s=i.val();if(t=navigator.appVersion.indexOf("Mac")!==-1?e.metaKey:e.altKey,!this.autocomplete.open||!this.autocomplete.onKeyDown(e))switch(!0){case 13===e.keyCode:return s=s.trim(),s&&($.each(s.split("\n"),function(e,t){try{n.processInput(t)}catch(e){window.console&&console.error(e)}}),this.buffer.push(s),this.buffer_pos=this.buffer.length),i.val(""),this.autocomplete.open&&this.autocomplete.close(),!1;case 38===e.keyCode:return this.buffer_pos>0&&(this.buffer_pos--,i.val(this.buffer[this.buffer_pos])),!1;case 40===e.keyCode:this.buffer_pos<this.buffer.length&&(this.buffer_pos++,i.val(this.buffer[this.buffer_pos]));break;case 219===e.keyCode&&t:var a=$("#kiwi .tabs").find("li[class!=connection]"),o=function(){for(var e=0;e<a.length;e++)if($(a[e]).hasClass("active"))return e}();return 0===o?$prev_tab=$(a[a.length-1]):$prev_tab=$(a[o-1]),$prev_tab.click(),!1;case 221===e.keyCode&&t:var a=$("#kiwi .tabs").find("li[class!=connection]"),o=function(){for(var e=0;e<a.length;e++)if($(a[e]).hasClass("active"))return e}();return o===a.length-1?$next_tab=$(a[0]):$next_tab=$(a[o+1]),$next_tab.click(),!1;case!(9!==e.keyCode||e.shiftKey||e.altKey||e.metaKey||e.ctrlKey):e.preventDefault();var c=[],l=g.app.panels().active.get("members");l&&l.forEach(function(e){e&&c.push({match:[e.get("nick")],type:"nick"})}),c.push(g.app.panels().active.get("name")),c=_.sortBy(c,function(e){return"nick"===e.type?e.match[0].toLowerCase():e.toLowerCase()}),this.showAutocomplete(c,"nicks");break;case 191===e.keyCode&&""===s:this.showAutocomplete(this.autocomplete_command_list,"command",!0)}},setAutoCompleteCommands:function(e){_.each(e,function(e){this.autocomplete_command_list.push({match:e.matches||[],description:e.description})},this)},inputBlur:function(e){return this.autocomplete.cancel_blur?void delete this.autocomplete.cancel_blur:void this.autocomplete.cancel("lost_focus")},processInput:function(e){var t,n,i,s=this;"/"===e[0]||g.app.panels().active.isChannel()||g.app.panels().active.isQuery()||(e="/"+e),"/"===e[0]&&"//"!==e.substr(0,2)||(e=e.replace(/^\/\//,"/"),e="/msg "+g.app.panels().active.get("name")+" "+e),this.preprocessor.vars.server=g.app.connections.active_connection.get("name"),this.preprocessor.vars.channel=g.app.panels().active.get("name"),this.preprocessor.vars.destination=this.preprocessor.vars.channel,e=this.preprocessor.process(e),n=e.split(/\s/),"/"===n[0][0]?(t=n[0].substr(1).toLowerCase(),n=n.splice(1,n.length-1)):(t="msg",n.unshift(g.app.panels().active.get("name"))),i={command:t,params:n},g.global.events.emit("command",i).then(function(){s.trigger("command",{command:i.command,params:i.params}),s.trigger("command:"+i.command,{command:i.command,params:i.params}),s._events["command:"+i.command]||s.trigger("unknown_command",{command:i.command,params:i.params})})},showAutocomplete:function(e,t,n){var i=this.$(".inp"),s=i.val().trim().substring(0,i[0].selectionStart).split(" ");this.autocomplete_token_idx=s.length-1,this.autocomplete_before={value:i.val(),caret_pos:i[0].selectionStart},this.autocomplete.showUi(!!g.global.settings.get("show_autocomplete_slideout")),this.autocomplete.setTitle(t),this.autocomplete.setWords(e,n),this.autocomplete.update(s[s.length-1]),this.autocomplete.show()},addPluginIcon:function(e){var t=$('<div class="tool"></div>').append(e);this.$el.find(".input_tools").append(t),g.app.view.doLayout()}});var f=Backbone.View.extend({events:{"click .autocomplete-item":"onItemClick","mousemove .autocomplete-item":"onItemMouseMove",mousedown:"onMouseDown","click .autocomplete-item .action":"onActionClick"},initialize:function(){this.$list=$('<ul class="autocomplete-list"></ul>'),this.$list.appendTo(this.$el),this.reset(),this.open=!1,this._show_ui=!0,this.filter_list=!1},render:function(){return this},showUi:function(e){this._show_ui=e},setWords:function(e,t){var n=[],i='<li class="autocomplete-item"><span class="word"><%= word %></span><span class="matches"><%= match_list %></span><span class="description"><%= description %></span></li>',s='<li class="autocomplete-item autocomplete-nick" data-nick="<%= word %>"><span class="word"><%= match_list %></span><span class="actions"><a class="action" data-event="message">Message</a><a class="action" data-event="more">More...</a></span></li>',a={};this.reset(),this.filter_list=!!t,_.each(e,function(e){var t,o,c;this._show_ui?("string"==typeof e?(a.match_list="",a.word=e,a.description=""):(a.match_list=a.word=e.match.length>1?e.match.join(", "):"",a.description=e.description||""),t="nick"===e.type?s:i,o=$(_.template(t)(a)).hide(),c=o.find(".word")):(t="",o=null,c=null);var l={match:"string"==typeof e?[e]:e.match,type:"nick"===e.type?"nick":"default",$el:o,$word:c};n.push(l),o&&o.data("word",l),o&&o.appendTo(this.$list)},this),this.list=n},setTitle:function(e){var t={nicks:"People or channels",command:"Commands"};this.$(".autocomplete-header-label").text(t[e]||t.nicks)},update:function(e){var t=null;return(null===this.matching_against_word||e.toLowerCase()!==this.matching_against_word.toLowerCase())&&(this.matches=_.filter(this.list,function(n){var i=_.find(n.match,function(t){if(0===t.toLowerCase().indexOf(e.toLowerCase()))return t});return i?(n.matched_word=i,this._show_ui&&(n.$word.text(i),n.$el.show()),t||(t=n)):(n.matched_word=null,this._show_ui&&n.$el.hide()),i},this),this.matching_against_word=e,this.$(".selected").removeClass("selected"),this.selected_idx=0,void(t?(this.selectEl(this.matches[0].$el),this.trigger("selected",t.matched_word,t)):this.trigger("selected",null)))},show:function(){this.open=!0,this._show_ui&&(this.$el.css("max-height",g.app.view.$el.height()/2+"px").show(),this.$list.css("max-height",g.app.view.$el.height()/2-32+"px").show())},close:function(){this.open=!1,this._show_ui&&this.$el.hide(),this.reset(),this.trigger("close")},reset:function(){this.matching_against_word=null,this._show_ui&&this.$list.empty(),this.list=[],this.matches=[],this.selected_idx=0},onMouseDown:function(e){e.preventDefault(),this.cancel_blur=!0,_.defer(_.bind(function(){delete this.cancel_blur},this))},onItemClick:function(e){var t=$(e.currentTarget).data("word");t&&this.trigger("match",t.matched_word,t)},onItemMouseMove:function(e){if($this=$(e.currentTarget),!$this.hasClass("selected")){var t=null;_.each(this.matches,function(e,n){if(e.$el[0]===$this[0])return t=n,!1}),null!==t&&(this.selected_idx=t,this.selectEl($this))}},onActionClick:function(e){e.stopPropagation();var t=$(e.currentTarget),n=t.data("event"),i=t.parents(".autocomplete-item"),s=i.data("word");this.trigger("action-"+n,s.matched_word,s)},previous:function(){this.selected_idx=this.matches[this.selected_idx-1]?this.selected_idx-1:this.matches.length-1,this.matches[this.selected_idx]&&(this.selectEl(this.matches[this.selected_idx].$el,!0),this.trigger("selected",this.matches[this.selected_idx].matched_word,this.matches[this.selected_idx]))},next:function(){this.selected_idx=this.matches[this.selected_idx+1]?this.selected_idx+1:0,this.matches[this.selected_idx]&&(this.selectEl(this.matches[this.selected_idx].$el,!0),this.trigger("selected",this.matches[this.selected_idx].matched_word,this.matches[this.selected_idx]))},cancel:function(e){this.trigger("cancel",e)},selectEl:function(e,t){var n,i;this._show_ui&&(this.$(".selected").removeClass("selected"),e&&e.addClass("selected"),e&&t&&(n=this.$el[0],i=this.$el.height(),e[0].scrollIntoView(),e.position().top+e.outerHeight()>i/2?n.scrollTop=n.scrollHeight:n.scrollTop-=i/2))},currentMatch:function(){return this.matches[this.selected_idx]?this.matches[this.selected_idx].matched_word:null},onKeyDown:function(e){if(this.open){var t=$(e.currentTarget),n=!1,i=t[0].selectionStart;return 38===e.keyCode||9===e.keyCode&&e.shiftKey?(this.previous(),e.preventDefault(),n=!0):40===e.keyCode||9===e.keyCode?(this.next(),e.preventDefault(),n=!0):1!==i||37!==e.keyCode&&8!==e.keyCode?13===e.keyCode?this.matches[this.selected_idx]&&(this.trigger("match",this.currentMatch(),this.matches[this.selected_idx]),e.preventDefault(),n=!!this._show_ui):27===e.keyCode?this.cancel():32===e.keyCode?this.cancel("typing"):16===e.keyCode?n=!0:this.filter_list||this.cancel("typing"):(e.preventDefault(),this.cancel("caret_moved")),n}}});g.view.Favicon=Backbone.View.extend({initialize:function(){var e=this,t=$(window);this.has_focus=!0,this.highlight_count=0,this.has_canvas_support=!!window.CanvasRenderingContext2D,this.original_favicon=$('link[rel~="icon"]')[0].href,this._createCanvas(),t.on("focus",function(){e.has_focus=!0,e._resetHighlights()}),t.on("blur",function(){e.has_focus=!1})},newHighlight:function(){var e=this;this.has_focus||(this.highlight_count++,this.has_canvas_support&&this._drawFavicon(function(){e._drawBubble(e.highlight_count.toString()),e._refreshFavicon(e.canvas.toDataURL())}))},_resetHighlights:function(){this.highlight_count=0,this._refreshFavicon(this.original_favicon)},_drawFavicon:function(e){var t=this.canvas,n=t.getContext("2d"),i=new Image;i.crossOrigin="anonymous",i.src=this.original_favicon,i.onload=function(){n.clearRect(0,0,t.width,t.height),n.drawImage(i,0,0,t.width,t.height),e()}},_drawBubble:function(e){var t,n=0,i=0,s=this.canvas,a=test_context=s.getContext("2d"),o=s.width,c=s.height;t=navigator.appVersion.indexOf("Mac")!==-1?-1.5:-1,test_context.font=a.font="bold 10px Arial",test_context.textAlign="right",this._renderText(test_context,e,0,0,t),n=test_context.measureText(e).width+t*(e.length-1)+2,i=9,bubbleX=o-n,bubbleY=c-i,a.fillStyle="red",a.fillRect(bubbleX,bubbleY,n,i),a.fillStyle="white",this._renderText(a,e,o-1,c-1,t)},_refreshFavicon:function(e){$('link[rel~="icon"]').remove(),$('<link rel="shortcut icon" href="'+e+'">').appendTo($("head"))},_createCanvas:function(){var e=document.createElement("canvas");e.width=16,e.height=16,this.canvas=e},_renderText:function(e,t,n,i,s){for(var a,o=t.split("").reverse(),c=0,l=n;c<t.length;)a=o[c++],e.fillText(a,l,i),l+=-1*(e.measureText(a).width+s);return e}}),g.view.MediaMessage=Backbone.View.extend({events:{"click .media_close":"close"},initialize:function(){this.url=this.$el.data("url")},toggle:function(){this.$content&&this.$content.is(":visible")?this.close():this.open()},close:function(){var e=this;this.$content.slideUp("fast",function(){e.$content.remove()})},open:function(){this.$content||(this.$content=$('<div class="media_content"><a class="media_close"><i class="fa fa-chevron-up"></i> '+g.global.i18n.translate("client_views_mediamessage_close").fetch()+'</a><br /><div class="content"></div></div>'),this.$content.find(".content").append(this.mediaTypes[this.$el.data("type")].apply(this,[])||g.global.i18n.translate("client_views_mediamessage_notfound").fetch()+" :(")),this.$content.is(":visible")||(this.$content.hide(),this.$el.append(this.$content),this.$content.slideDown())},mediaTypes:{twitter:function(){var e=this.$el.data("tweetid"),t=this;return $.getJSON("https://api.twitter.com/1/statuses/oembed.json?id="+e+"&callback=?",function(e){t.$content.find(".content").html(e.html)}),$("<div>"+g.global.i18n.translate("client_views_mediamessage_load_tweet").fetch()+"...</div>")},image:function(){return $('<a href="'+this.url+'" target="_blank"><img height="100" src="'+this.url+'" /></a>')},imgur:function(){var e=this;return $.getJSON("https://api.imgur.com/oembed?url="+this.$el.data("id")+"&maxheight=100&maxwidth=100",function(t){e.$content.find(".content").html(t.html)}).fail(function(){e.$content.find(".content").html('<i class="fa fa-exclamation-triangle"></i> No content.')}),$("<div>"+g.global.i18n.translate("client_views_mediamessage_load_image").fetch()+"...</div>")},reddit:function(){var e=this,t=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(this.url);return $.getJSON("https://www."+t[0]+".json?jsonp=?",function(t){console.log("Loaded reddit data",t);var n=t[0].data.children[0].data,i="";if(n.thumbnail){var s="https"+n.thumbnail.substr(4);n.over_18?(i="<span class=\"thumbnail_nsfw\" onclick=\"$(this).find('p').remove(); $(this).find('img').css('visibility', 'visible');\">",i+='<p style="font-size:0.9em;line-height:1.2em;cursor:pointer;">Show<br />NSFW</p>',i+='<img src="'+s+'" class="thumbnail" style="visibility:hidden;" />',i+="</span>"):i='<img src="'+s+'" class="thumbnail" />'}var a="<div>"+i+"<b><%- title %></b><br />Posted by <%- author %>. &nbsp;&nbsp; ";a+='<i class="fa fa-arrow-up"></i> <%- ups %> &nbsp;&nbsp; <i class="fa fa-arrow-down"></i> <%- downs %><br />',a+='<%- num_comments %> comments made. <a href="https://www.reddit.com<%- permalink %>">View post</a></div>',e.$content.find(".content").html(_.template(a)(n))}),$("<div>"+g.global.i18n.translate("client_views_mediamessage_load_reddit").fetch()+"...</div>")},youtube:function(){var e=this.$el.data("ytid"),t=this,n='<iframe width="480" height="270" src="https://www.youtube.com/embed/'+e+'?feature=oembed" frameborder="0" allowfullscreen=""></iframe>';return t.$content.find(".content").html(n),$("")},gist:function(){var e=this,t=/https?:\/\/gist\.github\.com\/(?:[a-z0-9-]*\/)?([a-z0-9]+)(\#(.+))?$/i.exec(this.url);return $.getJSON("https://gist.github.com/"+t[1]+".json?callback=?"+(t[2]||""),function(t){$("body").append('<link rel="stylesheet" href="'+t.stylesheet+'" type="text/css" />'),e.$content.find(".content").html(t.div)}),$("<div>"+g.global.i18n.translate("client_views_mediamessage_load_gist").fetch()+"...</div>")},spotify:function(){var e,t,n=this.$el.data("uri"),i=this.$el.data("method");switch(i){case"track":case"album":e={url:"https://embed.spotify.com/?uri="+n,width:300,height:80};break;case"artist":e={url:"https://embed.spotify.com/follow/1/?uri="+n+"&size=detail&theme=dark",width:300,height:56}}return t='<iframe src="'+e.url+'" width="'+e.width+'" height="'+e.height+'" frameborder="0" allowtransparency="true"></iframe>',$(t)},soundcloud:function(){var e=this.$el.data("url"),t=$("<div></div>").text(g.global.i18n.translate("client_models_applet_loading").fetch());return $.getJSON("https://soundcloud.com/oembed",{url:e}).then(function(e){t.empty().append($(e.html).attr("height",e.height-100))},function(){t.text(g.global.i18n.translate("client_views_mediamessage_notfound").fetch())}),t},streamable:function(){var e=this;return $.getJSON("http://api.streamable.com/oembed.json?url="+this.$el.data("url")+"&maxwidth=300",function(t){e.$content.find(".content").html(t.html)}).fail(function(){e.$content.find(".content").text(g.global.i18n.translate("client_views_mediamessage_notfound").fetch())}),$("<div>"+g.global.i18n.translate("client_models_applet_loading").fetch()+"</div>")},custom:function(){var e=this.constructor.types[this.$el.data("index")];if(e)return $(e.buildHtml(this.$el.data("url")))}}},{addType:function(e,t){"function"==typeof e&&"function"==typeof t&&(this.types=this.types||[],this.types.push({match:e,buildHtml:t}))},buildHtml:function(e){var t,n="";if(_.each(this.types||[],function(t,i){t.match(e)&&(n+='<span class="media" title="Open" data-type="custom" data-index="'+i+'" data-url="'+_.escape(e)+'"><a class="open"><i class="fa fa-chevron-right"></i></a></span>')}),e.match(/(\.jpe?g|\.gif|\.bmp|\.png)\??$/i)&&(n+='<span class="media image" data-type="image" data-url="'+e+'" title="Open Image"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/imgur.com\/((?:.[^\/]+)|(?:a\/.+)|(?:.*\/(.+)))/gi.exec(e),t&&!e.match(/(\.jpe?g|\.gif|\.bmp|\.png)\??$/i)&&(n+='<span class="media imgur" data-type="imgur" data-id="'+t[t[2]?2:1]+'" title="Open Image"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/https?:\/\/twitter.com\/([a-zA-Z0-9_]+)\/status\/([0-9]+)/gi.exec(e),t&&(n+='<span class="media twitter" data-type="twitter" data-url="'+e+'" data-tweetid="'+t[2]+'" title="Show tweet information"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/reddit\.com\/r\/([a-zA-Z0-9_\-]+)\/comments\/([a-z0-9]+)\/([^\/]+)?/gi.exec(e),t&&(n+='<span class="media reddit" data-type="reddit" data-url="'+e+'" title="Reddit thread"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/ ]{11})/gi.exec(e),t&&(n+='<span class="media youtube" data-type="youtube" data-url="'+e+'" data-ytid="'+t[1]+'" title="YouTube Video"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/https?:\/\/gist\.github\.com\/(?:[a-z0-9-]*\/)?([a-z0-9]+)(\#(.+))?$/i.exec(e),t&&(n+='<span class="media gist" data-type="gist" data-url="'+e+'" data-gist_id="'+t[1]+'" title="GitHub Gist"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/https?:\/\/(?:play|open\.)?spotify.com\/(album|track|artist)\/([a-zA-Z0-9]+)\/?/i.exec(e)){var i=t[1],s="spotify:"+t[1]+":"+t[2];n+='<span class="media spotify" data-type="spotify" data-uri="'+s+'" data-method="'+i+'" title="Spotify '+i+'"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'}return t=/(?:m\.)?(soundcloud\.com(?:\/.+))/i.exec(e),t&&(n+='<span class="media soundcloud" data-type="soundcloud" data-url="http://'+t[1]+'" title="SoundCloud player"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),t=/https?:\/\/streamable.com\/[a-z0-9]+$/i.exec(e),t&&(n+='<span class="media streamable" data-type="streamable" data-url="'+e+'" title="Streamable"><a class="open"><i class="fa fa-chevron-right"></i></a></span>'),n}}),g.view.Member=Backbone.View.extend({tagName:"li",initialize:function(e){this.model.bind("change",this.render,this),this.render()},render:function(){var e=this.$el,t=(this.model.get("modes")||[]).join(" ");return e.attr("class","mode "+t),e.html('<a class="nick"><span class="prefix">'+this.model.get("prefix")+"</span>"+this.model.get("nick")+"</a>"),this}}),g.view.MemberList=Backbone.View.extend({tagName:"div",events:{"click .nick":"nickClick","contextmenu .nick":"nickClick","dblclick .nick":"nickClick","click .channel_info":"channelInfoClick"},initialize:function(e){this.model.bind("all",this.render,this),this.$el.appendTo("#kiwi .memberlists"),this.$meta=$('<div class="meta"></div>').appendTo(this.$el),this.$list=$("<ul></ul>").appendTo(this.$el)},render:function(){var e=this;return this.$list.empty(),this.model.forEach(function(t){t.view.$el.data("member",t),e.$list.append(t.view.$el)}),this.model.channel.isActive()&&this.renderMeta(),this},renderMeta:function(){var e=this.model.length+" "+p("client_applets_chanlist_users");this.$meta.text(e)},nickClick:function(e){var t=$(e.currentTarget).parent("li"),n=t.data("member");g.global.events.emit("nick:select",{target:t,member:n,network:this.model.channel.get("network"),source:"nicklist",$event:e}).then(_.bind(this.openUserMenuForItem,this,t))},openUserMenuForItem:function(e){var t,n=e.data("member"),i=!!this.model.getByNick(g.app.connections.active_connection.get("nick")).get("is_op");t=new g.view.UserBox,t.setTargets(n,this.model.channel),t.displayOpItems(i);var s=new g.view.MenuBox(n.get("nick")||"User");s.addItem("userbox",t.$el),s.showFooter(!1),g.global.events.emit("usermenu:created",{menu:s,userbox:t,user:n}).then(_.bind(function(){s.show();var t=e.offset(),n=t.top,i=n+s.$el.outerHeight(),a=this.$el.parent().offset().top+this.$el.parent().outerHeight(),o=t.left,c=o+s.$el.outerWidth(),l=this.$el.parent().offset().left+this.$el.parent().outerWidth();i>a&&(n=a-s.$el.outerHeight()),n<0&&(n=0),c>l&&(o=l-s.$el.outerWidth()),s.$el.offset({left:o,top:n})},this)).then(null,_.bind(function(){t=null,s.dispose(),s=null},this))},channelInfoClick:function(e){new g.model.ChannelInfo({channel:this.model.channel})},show:function(){$("#kiwi .memberlists").children().removeClass("active"),$(this.el).addClass("active"),this.renderMeta()}}),g.view.MenuBox=Backbone.View.extend({events:{"click .ui_menu_foot .close, a.close_menu":"dispose"},initialize:function(e){this.$el=$('<div class="ui_menu"><div class="items"></div></div>'),this._title=e||"",this._items={},this._display_footer=!0,this._close_on_blur=!0},render:function(){var e,t=this,n=t.$el.find(".items");n.find("*").remove(),this._title&&(e=$('<div class="ui_menu_title"></div>').text(this._title),this.$el.prepend(e)),_.each(this._items,function(e){var t=$('<div class="ui_menu_content hover"></div>').append(e);n.append(t)}),this._display_footer&&this.$el.append('<div class="ui_menu_foot"><a class="close" onclick="">Close <i class="fa fa-times"></i></a></div>')},setTitle:function(e){this._title=e,this._title&&this.$el.find(".ui_menu_title").text(this._title)},onDocumentClick:function(e){var t=$(e.target);this._close_on_blur&&t[0]!=this.$el[0]&&0===this.$el.has(t).length&&this.dispose()},dispose:function(){_.each(this._items,function(e){e.dispose&&e.dispose(),e.remove&&e.remove()}),this._items=null,this.remove(),this._close_proxy&&$(document).off("click",this._close_proxy)},addItem:function(e,t){t.is("a")&&t.addClass("fa fa-chevron-right"),this._items[e]=t},removeItem:function(e){delete this._items[e]},showFooter:function(e){this._display_footer=e},closeOnBlur:function(e){this._close_on_blur=e},show:function(){var e,t,n=this;this.render(),this.$el.appendTo(g.app.view.$el),e=g.app.view.$el.find(".controlbox"),$items=this.$el.find(".items"),t=this.$el.outerHeight()-$items.outerHeight(),$items.css({"overflow-y":"auto","max-height":e.offset().top-this.$el.offset().top-t}),setTimeout(function(){n._close_proxy=function(e){n.onDocumentClick(e)},$(document).on("click",n._close_proxy)},0)}}),g.view.NetworkTabs=Backbone.View.extend({tagName:"ul",className:"connections",initialize:function(){this.model.on("add",this.networkAdded,this),this.model.on("remove",this.networkRemoved,this),this.$el.appendTo(g.app.view.$el.find(".tabs"))},networkAdded:function(e){$('<li class="connection"></li>').append(e.panels.view.$el).appendTo(this.$el)},networkRemoved:function(e){e.panels.view.$el.parent().remove(),e.panels.view.remove(),g.app.view.doLayout()}}),g.view.NickChangeBox=Backbone.View.extend({events:{submit:"changeNick","click .cancel":"close"},initialize:function(){var e={new_nick:g.global.i18n.translate("client_views_nickchangebox_new").fetch(),change:g.global.i18n.translate("client_views_nickchangebox_change").fetch(),cancel:g.global.i18n.translate("client_views_nickchangebox_cancel").fetch()};this.$el=$(_.template($("#tmpl_nickchange").html().trim())(e))},render:function(){g.app.controlbox.$el.prepend(this.$el),this.$el.find("input").focus(),this.$el.css("bottom",g.app.controlbox.$el.outerHeight(!0))},close:function(){this.$el.remove(),this.trigger("close")},changeNick:function(e){e.preventDefault();var t=g.app.connections.active_connection;this.listenTo(t,"change:nick",function(){this.close()}),t.gateway.changeNick(this.$("input").val())}}),g.view.ResizeHandler=Backbone.View.extend({events:{mousedown:"startDrag",mouseup:"stopDrag"},initialize:function(){this.dragging=!1,this.starting_width={},$(window).on("mousemove",$.proxy(this.onDrag,this))},startDrag:function(e){this.dragging=!0},stopDrag:function(e){this.dragging=!1},onDrag:function(e){if(this.dragging){var t=$("#kiwi").offset().left;this.$el.css("left",e.clientX-this.$el.outerWidth(!0)/2-t),$("#kiwi .right_bar").css("width",this.$el.parent().width()-(this.$el.position().left+this.$el.outerWidth())),g.app.view.doLayout()}}}),g.view.ServerSelect=Backbone.View.extend({events:{"submit form":"submitForm","click .show_more":"showMore","change .have_pass input":"showPass","change .have_key input":"showKey","click .fa-key":"channelKeyIconClick","click .show_server":"showServer"},initialize:function(){var e={think_nick:g.global.i18n.translate("client_views_serverselect_form_title").fetch(),nickname:g.global.i18n.translate("client_views_serverselect_nickname").fetch(),have_password:g.global.i18n.translate("client_views_serverselect_enable_password").fetch(),password:g.global.i18n.translate("client_views_serverselect_password").fetch(),channel:g.global.i18n.translate("client_views_serverselect_channel").fetch(),channel_key:g.global.i18n.translate("client_views_serverselect_channelkey").fetch(),require_key:g.global.i18n.translate("client_views_serverselect_channelkey_required").fetch(),key:g.global.i18n.translate("client_views_serverselect_key").fetch(),start:g.global.i18n.translate("client_views_serverselect_connection_start").fetch(),server_network:g.global.i18n.translate("client_views_serverselect_server_and_network").fetch(),server:g.global.i18n.translate("client_views_serverselect_server").fetch(),port:g.global.i18n.translate("client_views_serverselect_port").fetch(),powered_by:g.global.i18n.translate("client_views_serverselect_poweredby").fetch()};this.$el=$(_.template($("#tmpl_server_select").html().trim())(e)),g.app.server_settings&&g.app.server_settings.connection&&(g.app.server_settings.connection.allow_change||(this.$el.find(".show_more").remove(),this.$el.addClass("single_server"))),this.state="all",this.more_shown=!1,this.model.bind("new_network",this.newNetwork,this),this.gateway=g.global.components.Network(),this.gateway.on("connect",this.networkConnected,this),this.gateway.on("connecting",this.networkConnecting,this),this.gateway.on("disconnect",this.networkDisconnected,this),this.gateway.on("irc_error",this.onIrcError,this)},dispose:function(){this.model.off("new_network",this.newNetwork,this),this.gateway.off(),this.remove()},submitForm:function(e){return e.preventDefault(),$("input.nick",this.$el).val().trim()?("nick_change"===this.state?this.submitNickChange(e):this.submitLogin(e),void $("button",this.$el).attr("disabled",1)):(this.setStatus(g.global.i18n.translate("client_views_serverselect_nickname_error_empty").fetch()),void $("input.nick",this.$el).select())},submitLogin:function(e){if(!$("button",this.$el).attr("disabled")){var t={nick:$("input.nick",this.$el).val(),server:$("input.server",this.$el).val(),port:$("input.port",this.$el).val(),ssl:$("input.ssl",this.$el).prop("checked"),password:$("input.password",this.$el).val(),channel:$("input.channel",this.$el).val(),channel_key:$("input.channel_key",this.$el).val(),options:this.server_options};this.trigger("server_connect",t)}},submitNickChange:function(e){g.gateway.changeNick(null,$("input.nick",this.$el).val()),this.networkConnecting()},showPass:function(e){this.$el.find("tr.have_pass input").is(":checked")?this.$el.find("tr.pass").show().find("input").focus():this.$el.find("tr.pass").hide().find("input").val("")},channelKeyIconClick:function(e){this.$el.find("tr.have_key input").click()},showKey:function(e){this.$el.find("tr.have_key input").is(":checked")?this.$el.find("tr.key").show().find("input").focus():this.$el.find("tr.key").hide().find("input").val("")},showMore:function(e){this.more_shown?($(".more",this.$el).slideUp("fast"),$(".show_more",this.$el).children(".fs-caret-up").removeClass("fa-caret-up").addClass("fa-caret-down"),$("input.nick",this.$el).select(),this.more_shown=!1):($(".more",this.$el).slideDown("fast"),$(".show_more",this.$el).children(".fa-caret-down").removeClass("fa-caret-down").addClass("fa-caret-up"),$("input.server",this.$el).select(),this.more_shown=!0)},populateFields:function(e){var t,n,i,s,a,o,c;e=e||{},
t=e.nick||"",n=e.server||"",i=e.port||6667,o=e.ssl||0,c=e.password||"",s=e.channel||"",a=e.channel_key||"",$("input.nick",this.$el).val(t),$("input.server",this.$el).val(n),$("input.port",this.$el).val(i),$("input.ssl",this.$el).prop("checked",o),$("input#server_select_show_pass",this.$el).prop("checked",!!c),$("input.password",this.$el).val(c),c&&$("tr.pass",this.$el).show(),$("input.channel",this.$el).val(s),$("input#server_select_show_channel_key",this.$el).prop("checked",!!a),$("input.channel_key",this.$el).val(a),a&&$("tr.key",this.$el).show(),this.server_options={},e.encoding&&(this.server_options.encoding=e.encoding)},hide:function(){this.$el.slideUp()},show:function(e){e=e||"all",this.$el.show(),"all"===e?$(".show_more",this.$el).show():"more"===e?$(".more",this.$el).slideDown("fast"):"nick_change"===e?($(".more",this.$el).hide(),$(".show_more",this.$el).hide(),$("input.nick",this.$el).select()):"enter_password"===e&&($(".more",this.$el).hide(),$(".show_more",this.$el).hide(),$("input.password",this.$el).select()),this.state=e},infoBoxShow:function(){var e=this.$el.find(".side_panel");e.is(":visible")&&this.$el.animate({width:parseInt(e.css("left"),10)+e.find(".content:first").outerWidth()})},infoBoxHide:function(){var e=this.$el.find(".side_panel");this.$el.animate({width:parseInt(e.css("left"),10)})},infoBoxSet:function(e){this.$el.find(".side_panel .content").empty().append(e)},setStatus:function(e,t){$(".status",this.$el).text(e).attr("class","status").addClass(t||"").show()},clearStatus:function(){$(".status",this.$el).hide()},reset:function(){this.populateFields(),this.clearStatus(),this.$("button").attr("disabled",null)},newNetwork:function(e){this.model.current_connecting_network=e},networkConnected:function(e){this.model.trigger("connected",g.app.connections.getByConnectionId(e.server)),this.model.current_connecting_network=null},networkDisconnected:function(){this.model.current_connecting_network=null,this.state="all"},networkConnecting:function(e){this.model.trigger("connecting"),this.setStatus(g.global.i18n.translate("client_views_serverselect_connection_trying").fetch(),"ok"),this.$(".status").append('<a class="show_server"><i class="fa fa-info-circle"></i></a>')},showServer:function(){this.model.current_connecting_network&&(g.app.view.barsShow(),this.model.current_connecting_network.panels.server.view.show())},onIrcError:function(e){switch($("button",this.$el).attr("disabled",null),e.error){case"nickname_in_use":this.setStatus(g.global.i18n.translate("client_views_serverselect_nickname_error_alreadyinuse").fetch()),this.show("nick_change"),this.$el.find(".nick").select();break;case"erroneus_nickname":e.reason?this.setStatus(e.reason):this.setStatus(g.global.i18n.translate("client_views_serverselect_nickname_invalid").fetch()),this.show("nick_change"),this.$el.find(".nick").select();break;case"password_mismatch":this.setStatus(g.global.i18n.translate("client_views_serverselect_password_incorrect").fetch()),this.show("enter_password"),this.$el.find(".password").select();break;default:this.showError(e.reason||"")}},showError:function(e){var t=g.global.i18n.translate("client_views_serverselect_connection_error").fetch();if(e)switch(e){case"ENOTFOUND":t=g.global.i18n.translate("client_views_serverselect_server_notfound").fetch();break;case"ECONNREFUSED":t+=" ("+g.global.i18n.translate("client_views_serverselect_connection_refused").fetch()+")";break;default:t+=" ("+e+")"}this.setStatus(t,"error"),$("button",this.$el).attr("disabled",null),this.show()}}),g.view.StatusMessage=Backbone.View.extend({initialize:function(){this.$el.hide(),this.tmr=null},text:function(e,t){t=t||{},t.type=t.type||"",t.timeout=t.timeout||5e3,this.$el.text(e).addClass(t.type),this.$el.slideDown($.proxy(g.app.view.doLayout,g.app.view)),t.timeout&&this.doTimeout(t.timeout)},html:function(e,t){t=t||{},t.type=t.type||"",t.timeout=t.timeout||5e3,this.$el.html(e).addClass(t.type),this.$el.slideDown($.proxy(g.app.view.doLayout,g.app.view)),t.timeout&&this.doTimeout(t.timeout)},hide:function(){this.$el.slideUp($.proxy(g.app.view.doLayout,g.app.view))},doTimeout:function(e){this.tmr&&clearTimeout(this.tmr);var t=this;this.tmr=setTimeout(function(){t.hide()},e)}}),g.view.Tabs=Backbone.View.extend({tagName:"ul",className:"panellist",events:{"click li":"tabClick","click li .part":"partClick"},initialize:function(){this.model.on("add",this.panelAdded,this),this.model.on("remove",this.panelRemoved,this),this.model.on("reset",this.render,this),this.model.on("active",this.panelActive,this),this.is_network=!1,this.model.network&&(this.is_network=!0,this.model.network.on("change:name",function(e,t){$("span",this.model.server.tab).text(t)},this),this.model.network.on("change:connection_id",function(e,t){this.model.forEach(function(e){e.tab.data("connection_id",t)})},this))},render:function(){var e=this;this.$el.empty(),this.is_network&&this.model.server.tab.data("panel",this.model.server).data("connection_id",this.model.network.get("connection_id")).appendTo(this.$el),this.model.forEach(function(t){this.is_network&&t==e.model.server||(t.tab.data("panel",t),this.is_network&&t.tab.data("connection_id",this.model.network.get("connection_id")),t.tab.appendTo(e.$el))}),g.app.view.doLayout()},updateTabTitle:function(e,t){$("span",e.tab).text(t)},panelAdded:function(e){e.tab=$('<li><span></span><div class="activity"></div></li>'),e.tab.find("span").text(e.get("title")||e.get("name")),e.isServer()?(e.tab.addClass("server"),e.tab.addClass("fa"),e.tab.addClass("fa-nonexistant")):e.isChannel()?e.tab.addClass("channel"):e.isQuery()&&e.tab.addClass("query"),e.tab.data("panel",e),this.is_network&&e.tab.data("connection_id",this.model.network.get("connection_id")),this.sortTabs(),e.bind("change:title",this.updateTabTitle),e.bind("change:name",this.updateTabTitle),g.app.view.doLayout()},panelRemoved:function(e){g.app.connections.active_connection;e.tab.remove(),delete e.tab,g.app.panels.trigger("remove",e),g.app.view.doLayout()},panelActive:function(e,t){g.app.view.$el.find(".panellist .part").remove(),g.app.view.$el.find(".panellist .active").removeClass("active"),e.tab.addClass("active"),e.tab.append('<span class="part fa fa-nonexistant"></span>')},tabClick:function(e){var t=$(e.currentTarget),n=t.data("panel");n&&n.view.show()},partClick:function(e){var t=$(e.currentTarget).parent(),n=t.data("panel");n&&(n.isChannel()&&n.get("members").models.length>0?this.model.network.gateway.part(n.get("name")):n.isServer()?this.model.network.get("connected")&&!confirm(p("disconnect_from_server"))||(this.model.network.gateway.quit("Leaving"),g.app.connections.remove(this.model.network),g.app.startup_applet.view.show()):n.close())},sortTabs:function(){var e=this,t=[];this.model.forEach(function(n){e.is_network&&n==e.model.server||t.push([n.get("title")||n.get("name"),n])}),t.sort(function(e,t){return e[0].toLowerCase()>t[0].toLowerCase()?1:e[0].toLowerCase()<t[0].toLowerCase()?-1:0}),_.each(t,function(t){t[1].tab.appendTo(e.$el)})}}),g.view.TopicBar=Backbone.View.extend({events:{"keydown div":"process"},initialize:function(){g.app.panels.bind("active",function(e){e.isChannel()?(this.setCurrentTopicFromChannel(e),this.$el.find("div").attr("contentEditable",!0)):this.$el.find("div").attr("contentEditable",!1).text("")},this)},process:function(e){var t=$(e.currentTarget),n=t.text();return!!g.app.panels().active.isChannel()&&(13===e.keyCode?(g.app.connections.active_connection.gateway.topic(g.app.panels().active.get("name"),n),!1):void 0)},setCurrentTopic:function(e){e=e||"",$("div",this.$el).html(l(_.escape(e)))},setCurrentTopicFromChannel:function(e){var t=e.get("topic_set_by"),n="";this.setCurrentTopic(e.get("topic")),t?(n+=p("client_models_network_topic",[t.nick,g.utils.formatDate(t.when)]),this.$el.attr("title",n)):this.$el.attr("title","")}}),g.view.UserBox=Backbone.View.extend({events:{"click .query":"queryClick","click .info":"infoClick","change .ignore":"ignoreChange","click .ignore":"ignoreClick","click .op":"opClick","click .deop":"deopClick","click .voice":"voiceClick","click .devoice":"devoiceClick","click .kick":"kickClick","click .ban":"banClick"},initialize:function(){var e={op:g.global.i18n.translate("client_views_userbox_op").fetch(),de_op:g.global.i18n.translate("client_views_userbox_deop").fetch(),voice:g.global.i18n.translate("client_views_userbox_voice").fetch(),de_voice:g.global.i18n.translate("client_views_userbox_devoice").fetch(),kick:g.global.i18n.translate("client_views_userbox_kick").fetch(),ban:g.global.i18n.translate("client_views_userbox_ban").fetch(),message:g.global.i18n.translate("client_views_userbox_query").fetch(),info:g.global.i18n.translate("client_views_userbox_whois").fetch(),ignore:g.global.i18n.translate("client_views_userbox_ignore").fetch()};this.$el=$(_.template($("#tmpl_userbox").html().trim())(e))},setTargets:function(e,t){this.user=e,this.channel=t;var n=m(this.user.get("nick")),i=g.app.connections.active_connection.isUserIgnored(n);this.$(".ignore input").attr("checked",!!i&&"checked")},displayOpItems:function(e){e?this.$el.find(".if_op").css("display","block"):this.$el.find(".if_op").css("display","none")},queryClick:function(e){var t=this.user.get("nick");g.app.connections.active_connection.createQuery(t)},infoClick:function(e){g.app.controlbox.processInput("/whois "+this.user.get("nick"))},ignoreClick:function(e){e.stopPropagation()},ignoreChange:function(e){$(e.currentTarget).find("input").is(":checked")?g.app.controlbox.processInput("/ignore "+this.user.get("nick")):g.app.controlbox.processInput("/unignore "+this.user.get("nick"))},opClick:function(e){g.app.controlbox.processInput("/mode "+this.channel.get("name")+" +o "+this.user.get("nick"))},deopClick:function(e){g.app.controlbox.processInput("/mode "+this.channel.get("name")+" -o "+this.user.get("nick"))},voiceClick:function(e){g.app.controlbox.processInput("/mode "+this.channel.get("name")+" +v "+this.user.get("nick"))},devoiceClick:function(e){g.app.controlbox.processInput("/mode "+this.channel.get("name")+" -v "+this.user.get("nick"))},kickClick:function(e){g.app.controlbox.processInput("/kick "+this.user.get("nick")+" Bye!")},banClick:function(e){g.app.controlbox.processInput("/mode "+this.channel.get("name")+" +b "+this.user.get("nick")+"!*")}}),g.view.ChannelTools=Backbone.View.extend({events:{"click .channel_info":"infoClick","click .channel_part":"partClick"},initialize:function(){},infoClick:function(e){new g.model.ChannelInfo({channel:g.app.panels().active})},partClick:function(e){g.app.connections.active_connection.gateway.part(g.app.panels().active.get("name"))}}),g.view.ChannelInfo=Backbone.View.extend({events:{"click .toggle_banlist":"toggleBanList","change .channel-mode":"onModeChange","click .remove-ban":"onRemoveBanClick"},initialize:function(){var e,t=this.model.get("channel");e={moderated_chat:p("client_views_channelinfo_moderated"),invite_only:p("client_views_channelinfo_inviteonly"),ops_change_topic:p("client_views_channelinfo_opschangechannel"),external_messages:p("client_views_channelinfo_externalmessages"),toggle_banlist:p("client_views_channelinfo_togglebanlist"),channel_name:t.get("name")},this.$el=$(_.template($("#tmpl_channel_info").html().trim())(e)),this.menu=new g.view.MenuBox(t.get("name")),this.menu.addItem("channel_info",this.$el),this.menu.$el.appendTo(t.view.$container),this.menu.show(),this.menu.$el.offset({top:g.app.view.$el.find(".panels").offset().top}),this.$el.dispose=_.bind(this.dispose,this),this.updateInfo(t),t.on("change:info_modes change:info_url change:banlist",this.updateInfo,this),t.get("network").gateway.channelInfo(t.get("name"))},render:function(){},onModeChange:function(e){var t=$(e.currentTarget),n=this.model.get("channel"),i=t.data("mode"),s="";return"checkbox"==t.attr("type")?(s=t.is(":checked")?"+":"-",s+=i,void n.setMode(s)):"text"==t.attr("type")?(s=t.val()?"+"+i+" "+t.val():"-"+i,void n.setMode(s)):void 0},onRemoveBanClick:function(e){e.preventDefault(),e.stopPropagation();var t=$(e.currentTarget),n=t.parents("tr:first"),i=n.data("ban");if(i){var s=this.model.get("channel");s.setMode("-b "+i.banned),n.remove()}},updateInfo:function(e,t){var n,i,s,a=this;if(n=e.get("info_modes"),n&&_.each(n,function(e,t){e.mode=e.mode.toLowerCase(),"+k"==e.mode?a.$el.find('[name="channel_key"]').val(e.param):"+m"==e.mode?a.$el.find('[name="channel_mute"]').attr("checked","checked"):"+i"==e.mode?a.$el.find('[name="channel_invite"]').attr("checked","checked"):"+n"==e.mode?a.$el.find('[name="channel_external_messages"]').attr("checked","checked"):"+t"==e.mode&&a.$el.find('[name="channel_topic"]').attr("checked","checked")}),i=e.get("info_url"),i&&(this.$el.find(".channel_url").text(i).attr("href",i),this.$el.find(".channel_url").slideDown()),s=e.get("banlist"),s&&s.length){var o=this.$el.find(".channel-banlist table tbody");this.$el.find(".banlist-status").text(""),o.empty(),_.each(s,function(e){var t=$("<tr></tr>").data("ban",e);$("<td></td>").text(e.banned).appendTo(t),$("<td></td>").text(e.banned_by.split(/[!@]/)[0]).appendTo(t),$("<td></td>").text(g.utils.formatDate(new Date(1e3*parseInt(e.banned_at,10)))).appendTo(t),$('<td><i class="fa fa-rtimes remove-ban"></i></td>').appendTo(t),o.append(t)}),this.$el.find(".channel-banlist table").slideDown()}else this.$el.find(".banlist-status").text("Banlist empty"),this.$el.find(".channel-banlist table").hide()},toggleBanList:function(e){if(e.preventDefault(),this.$el.find(".channel-banlist table").toggle(),this.$el.find(".channel-banlist table").is(":visible")){var t=this.model.get("channel"),n=t.get("network");n.gateway.raw("MODE "+t.get("name")+" +b")}},dispose:function(){this.model.get("channel").off("change:info_modes change:info_url change:banlist",this.updateInfo,this),this.$el.remove()}}),g.view.RightBar=Backbone.View.extend({events:{"click .right-bar-toggle":"onClickToggle","click .right-bar-toggle-inner":"onClickToggle"},initialize:function(){this.keep_hidden=!1,this.hidden=this.$el.hasClass("disabled"),this.updateIcon()},hide:function(){this.hidden=!0,this.$el.addClass("disabled"),this.updateIcon()},show:function(){this.hidden=!1,this.keep_hidden||this.$el.removeClass("disabled"),this.updateIcon()},toggle:function(e){return!!this.ignore_layout||("undefined"==typeof e?this.keep_hidden=!this.keep_hidden:this.keep_hidden=e,this.keep_hidden||this.hidden?(this.$el.addClass("disabled"),this.$el.css("width","")):this.$el.removeClass("disabled"),void this.updateIcon())},updateIcon:function(){var e=this.$(".right-bar-toggle"),t=e.find("i");!this.hidden&&this.keep_hidden?e.show():e.hide(),this.keep_hidden?t.removeClass("fa fa-angle-double-right").addClass("fa fa-users"):t.removeClass("fa fa-users").addClass("fa fa-angle-double-right")},onClickToggle:function(e){this.toggle(),this.ignore_layout=!0,g.app.view.doLayout(),delete this.ignore_layout}}),g.view.Notification=Backbone.View.extend({className:"notification",events:{"click .close":"close"},initialize:function(e,t){this.title=e,this.content=t},render:function(){return this.$el.html($("#tmpl_notifications").html()),this.$("h6").text(this.title),"string"==typeof this.content?this.$(".content").html(this.content):"object"==typeof this.content&&this.$(".content").empty().append(this.content),this},show:function(){var e=this;this.render().$el.appendTo(g.app.view.$el),_.defer(function(){e.$el.addClass("show")})},close:function(){this.remove()}}),function(){function e(e,t){this.app=e,this.controlbox=t,this.addDefaultAliases(),this.bindCommand(n())}function n(){var e={unknown_command:i,command:s,"command:msg":{fn:c,description:p("command_description_msg")},"command:action":{fn:l,description:p("command_description_action"),aliases:["me"]},"command:join":{fn:a,description:p("command_description_join"),aliases:["j"]},"command:part":{fn:r,description:p("command_description_part"),aliases:["p"]},"command:cycle":{fn:h,description:p("command_description_cycle")},"command:nick":{fn:d,description:p("command_description_nick")},"command:query":{fn:o,description:p("command_description_query")},"command:invite":{fn:N,description:p("command_description_invite")},"command:topic":{fn:f,description:p("command_description_topic")},"command:notice":{fn:v,description:p("command_description_notice")},"command:quote":{fn:w,description:p("command_description_quote"),aliases:["raw"]},"command:kick":{fn:k,description:p("command_description_kick")},"command:names":{fn:b,description:""},"command:mode":{fn:y,description:""},"command:clear":{fn:x,description:p("command_description_clear")},"command:ctcp":{fn:C,description:p("command_description_ctcp")},"command:quit":{fn:z,description:p("command_description_quit"),aliases:["q"]},"command:server":{fn:A,description:p("command_description_server")},"command:whois":{fn:B,description:p("command_description_whois"),aliases:["w"]},"command:whowas":{fn:D,description:p("command_description_whowas")},"command:away":{fn:I,description:p("command_description_away")},"command:encoding":{fn:L,description:p("command_description_encoding")},"command:channel":{fn:j,description:""},"command:applet":{fn:T,description:""},"command:settings":{fn:M,description:p("command_description_settings")},"command:script":{fn:S,description:p("command_description_script")}};return e["command:css"]={description:p("command_description_css"),fn:function(e){this.app.view.reloadStyles()}},e["command:js"]={description:p("command_description_js"),fn:function(e){e.params[0]&&$script(e.params[0]+"?"+(new Date).getTime())}},e["command:set"]={description:p("command_description_set"),fn:function(e){if(e.params[0]){var t,n=e.params[0];e.params[1]&&(e.params.shift(),t=e.params.join(" "),"true"===t&&(t=!0),"false"===t&&(t=!1),parseInt(t,10).toString()===t&&(t=parseInt(t,10)),g.global.settings.set(n,t)),this.app.panels().active.addMsg("",u("set_setting",{text:n+" = "+g.global.settings.get(n).toString()}))}}},e["command:save"]={description:p("command_description_save"),fn:function(e){g.global.settings.save(),this.app.panels().active.addMsg("",u("settings_saved",{text:p("client_models_application_settings_saved")}))}},e["command:alias"]={description:p("command_description_alias"),fn:function(e){var t,n,i=this;return e.params[1]?"del"===e.params[0]||"delete"===e.params[0]?(t=e.params[1],"/"!==t[0]&&(t="/"+t),void delete this.controlbox.preprocessor.aliases[t]):(t=e.params[0],e.params.shift(),n=e.params.join(" "),"/"!==t[0]&&(t="/"+t),void(this.controlbox.preprocessor.aliases[t]=n)):void $.each(this.controlbox.preprocessor.aliases,function(e,t){i.app.panels().server.addMsg(" ",u("list_aliases",{text:e+"   =>   "+t}))})}},e["command:ignore"]={description:p("command_description_ignore"),fn:function(e){var t,n=this,i=this.app.connections.active_connection.ignore_list;return e.params[0]?(t=m(e.params[0]),i.addMask(t),void this.app.panels().active.addMsg(" ",u("ignore_nick",{text:p("client_models_application_ignore_nick",[t])}))):void(i.length>0?(this.app.panels().active.addMsg(" ",u("ignore_title",{text:p("client_models_application_ignore_title")})),i.forEach(function(e){n.app.panels().active.addMsg(" ",u("ignored_pattern",{text:e.get("mask")}))})):this.app.panels().active.addMsg(" ",u("ignore_none",{text:p("client_models_application_ignore_none")})))}},e["command:unignore"]={description:p("command_description_unignore"),fn:function(e){var t,n,i=this.app.connections.active_connection.ignore_list;return e.params[0]?(t=m(e.params[0]),n=i.where({mask:t}),n&&i.remove(n),void this.app.panels().active.addMsg(" ",u("ignore_stopped",{text:p("client_models_application_ignore_stopped",[t])}))):void this.app.panels().active.addMsg(" ",u("ignore_stop_notice",{text:p("client_models_application_ignore_stop_notice")}))}},e}function i(e){var t=e.command+" "+e.params.join(" ");this.app.connections.active_connection.gateway.raw(t)}function s(e){}function a(e){var t,n;n=e.params.join(" ").split(","),t=this.app.connections.active_connection.createAndJoinChannels(n),t.length&&t[t.length-1].view.show()}function o(e){var t,n,i;t=e.params[0],e.params.shift(),n=e.params.join(" "),i=this.app.connections.active_connection.panels.getByName(t),i||(i=new g.model.Query({name:t,network:this.app.connections.active_connection}),this.app.connections.active_connection.panels.add(i)),i&&i.view.show(),n&&(this.app.connections.active_connection.gateway.msg(i.get("name"),n),i.addMsg(this.app.connections.active_connection.get("nick"),u("privmsg",{text:n}),"privmsg"))}function c(e){var t,n=e.params[0],i=this.app.connections.active_connection.panels.getByName(n)||this.app.panels().server;e.params.shift(),t=e.params.join(" "),i.addMsg(this.app.connections.active_connection.get("nick"),u("privmsg",{text:t}),"privmsg"),this.app.connections.active_connection.gateway.msg(n,t)}function l(e){if(!this.app.panels().active.isServer()){var t=this.app.panels().active;t.addMsg("",u("action",{nick:this.app.connections.active_connection.get("nick"),text:e.params.join(" ")}),"action"),this.app.connections.active_connection.gateway.action(t.get("name"),e.params.join(" "))}}function r(e){var t,n,i=this;0===e.params.length?this.app.connections.active_connection.gateway.part(this.app.panels().active.get("name")):(t=e.params[0].split(","),n=e.params.slice(1).join(" "),_.each(t,function(e){i.app.connections.active_connection.gateway.part(e,n)}))}function h(e){var t,n=this;t=0===e.params.length?this.app.panels().active.get("name"):e.params[0],this.app.connections.active_connection.gateway.part(t),setTimeout(function(){n.app.connections.active_connection.createAndJoinChannels(t),n.app.connections.active_connection.panels.getByName(t).show()},1e3)}function d(e){this.app.connections.active_connection.gateway.changeNick(e.params[0])}function f(e){var t;0!==e.params.length&&(this.app.connections.active_connection.isChannelName(e.params[0])?(t=e.params[0],e.params.shift()):t=this.app.panels().active.get("name"),this.app.connections.active_connection.gateway.topic(t,e.params.join(" ")))}function v(e){var t;e.params.length<=1||(t=e.params[0],e.params.shift(),this.app.connections.active_connection.gateway.notice(t,e.params.join(" ")))}function w(e){var t=e.params.join(" ");this.app.connections.active_connection.gateway.raw(t)}function k(e){var t,n=this.app.panels().active;n.isChannel()&&0!==e.params.length&&(t=e.params[0],e.params.shift(),this.app.connections.active_connection.gateway.kick(n.get("name"),t,e.params.join(" ")))}function b(e){var t,n=this.app.panels().active;n.isChannel()&&(t=0===e.params.length?n.get("name"):e.params[0],this.app.connections.active_connection.gateway.raw("NAMES "+t))}function y(e){var t,n,i,s=this.app.panels().active;if(i=s.get("network")){if(i.isChannelName(e.params[0]))n=e.params[0],t=e.params.slice(1).join(" ");else{if(!s.isChannel())return;n=s.get("name"),t=e.params.join(" ")}t||i.gateway.on("channel_info",function e(t){if(t.channel.toLowerCase()===n.toLowerCase()&&"undefined"!=typeof t.modes){i.gateway.off("channel_info",e);var a=_.chain(t.modes).reduce(function(e,t){var n="-"===t.mode[0]?"-":"+";return e[n].push(t.mode.substr(1)),e},{"+":[],"-":[]}).reduce(function(e,t,n){return t.length>0&&(e+=n+t.join("")+" "),e},"").value();s.addMsg("",t.channel+" "+a)}}),this.app.connections.active_connection.gateway.raw("MODE "+n+" "+t)}}function x(e){this.app.panels().active.isServer()||this.app.panels().active.isApplet()||this.app.panels().active.clearMessages&&this.app.panels().active.clearMessages()}function C(e){var t,n;e.params.length<2||(t=e.params[0],e.params.shift(),n=e.params[0],e.params.shift(),this.app.connections.active_connection.gateway.ctcpRequest(n,t,e.params.join(" ")))}function M(e){var t=g.model.Applet.loadOnce("kiwi_settings");t.view.show()}function S(e){var t=g.model.Applet.loadOnce("kiwi_script_editor");t.view.show()}function T(e){if(e.params[0]){var t;if(e.params[1])t=t.loadFromUrl(e.params[0],e.params[1]);else if(t=g.model.Applet.loadOnce(e.params[0]),!t)return void this.app.panels().server.addMsg("",u("applet_notfound",{text:p("client_models_application_applet_notfound",[e.params[0]])}));t.view.show()}}function N(e){var t,n;e.params[0]&&this.app.panels().active.isChannel()&&(t=e.params[0],n=this.app.panels().active.get("name"),this.app.connections.active_connection.gateway.raw("INVITE "+t+" "+n),this.app.panels().active.addMsg("",u("channel_has_been_invited",{nick:t,text:p("client_models_application_has_been_invited",[n])}),"action"))}function B(e){var t;e.params[0]?t=e.params[0]:this.app.panels().active.isQuery()&&(t=this.app.panels().active.get("name")),t&&this.app.connections.active_connection.gateway.raw("WHOIS "+t+" "+t)}function D(e){var t;e.params[0]?t=e.params[0]:this.app.panels().active.isQuery()&&(t=this.app.panels().active.get("name")),t&&this.app.connections.active_connection.gateway.raw("WHOWAS "+t)}function I(e){this.app.connections.active_connection.gateway.raw("AWAY :"+e.params.join(" "))}function L(e){var t=this;e.params[0]?g.gateway.setEncoding(null,e.params[0],function(n){n?t.app.panels().active.addMsg("",u("encoding_changed",{text:p("client_models_application_encoding_changed",[e.params[0]])})):t.app.panels().active.addMsg("",u("encoding_invalid",{text:p("client_models_application_encoding_invalid",[e.params[0]])}))}):(this.app.panels().active.addMsg("",u("client_models_application_encoding_notspecified",{text:p("client_models_application_encoding_notspecified")})),this.app.panels().active.addMsg("",u("client_models_application_encoding_usage",{text:p("client_models_application_encoding_usage")})))}function j(e){var t=this.app.panels().active;t.isChannel()&&new g.model.ChannelInfo({channel:this.app.panels().active})}function z(e){var t=this.app.connections.active_connection;t&&t.gateway.quit(e.params.join(" "))}function A(e){var n,i,s,a,o,c,l=this;return e.params[0]?(e.params[0].indexOf(":")>0?(c=e.params[0].split(":"),n=c[0],i=c[1],a=e.params[1]||t):(n=e.params[0],i=e.params[1]||6667,a=e.params[2]||t),"+"===i.toString()[0]?(s=!0,i=parseInt(i.substring(1),10)):s=!1,i=i||6667,o=this.app.connections.active_connection.get("nick"),this.app.panels().active.addMsg("",u("server_connecting",{text:p("client_models_application_connection_connecting",[n,i.toString()])})),void g.gateway.newConnection({nick:o,host:n,port:i,ssl:s,password:a},function(e,t){var s;e&&(s=p("client_models_application_connection_error",[n,i.toString(),e.toString()]),l.app.panels().active.addMsg("",u("server_connecting_error",{text:s})))})):(c=new g.view.MenuBox(g.global.i18n.translate("client_models_application_connection_create").fetch()),c.addItem("new_connection",(new g.model.NewConnection).view.$el),c.show(),void c.$el.offset({top:this.app.view.$el.height()/2-c.$el.height()/2,left:this.app.view.$el.width()/2-c.$el.width()/2}))}g.misc.ClientUiCommands=e,e.prototype.addDefaultAliases=function(){$.extend(this.controlbox.preprocessor.aliases,{"/p":"/part $1+","/me":"/action $1+","/j":"/join $1+","/q":"/query $1+","/w":"/whois $1+","/raw":"/quote $1+","/connect":"/server $1+","/op":"/quote mode $channel +o $1+","/deop":"/quote mode $channel -o $1+","/hop":"/quote mode $channel +h $1+","/dehop":"/quote mode $channel -h $1+","/voice":"/quote mode $channel +v $1+","/devoice":"/quote mode $channel -v $1+","/k":"/kick $channel $1+","/ban":"/quote mode $channel +b $1+","/unban":"/quote mode $channel -b $1+","/slap":"/me slaps $1 around a bit with a large trout","/tick":"/msg $channel ✔"})},e.prototype.bindCommand=function(e){var t=this,n={};_.each(e,function(e,i){var s,a;"function"==typeof e?s=e:(s=e.fn,a=["/"+i.split(":")[1]],e.aliases&&(a=a.concat(_.map(e.aliases,function(e){return"/"+e}))),n["/"+i.split(":")[1]]={description:e.description,matches:a}),t.controlbox.on(i,_.bind(s,t))}),this.controlbox.setAutoCompleteCommands(n)}}(),function(){var e=Backbone.View.extend({events:{"change [data-setting]":"saveSettings",'click [data-setting="theme"]':"selectTheme","click .register_protocol":"registerProtocol","click .enable_notifications":"enableNotifications","click .show-category":"onClickShowCategory"},initialize:function(e){var t={messages:p("client_applets_settings_messages"),chat_messages:p("client_applets_settings_chat_messages"),alerts_notifications:p("client_applets_settings_alerts_notifications"),appearance:p("client_applets_settings_appearance"),theme:p("client_applets_settings_theme"),channels:p("client_applets_settings_channels"),tabs:p("client_applets_settings_channelview_tabs"),list:p("client_applets_settings_channelview_list"),large_amounts_of_chans:p("client_applets_settings_channelview_list_notice"),language:p("client_applets_settings_language"),join_part:p("client_applets_settings_notification_joinpart"),count_all_activity:p("client_applets_settings_notification_count_all_activity"),timestamps:p("client_applets_settings_timestamp"),timestamp_24:p("client_applets_settings_timestamp_24_hour"),mute:p("client_applets_settings_notification_sound"),emoticons:p("client_applets_settings_emoticons"),queries:p("client_applets_settings_ignore_new_queries"),scroll_history:p("client_applets_settings_history_length"),languages:g.app.translations,default_client:p("client_applets_settings_default_client"),make_default:p("client_applets_settings_default_client_enable"),locale_restart_needed:p("client_applets_settings_locale_restart_needed"),default_note:p("client_applets_settings_default_client_notice",'<a href="chrome://settings/handlers">chrome://settings/handlers</a>'),html5_notifications:p("client_applets_settings_html5_notifications"),enable_notifications:p("client_applets_settings_enable_notifications"),custom_highlights:p("client_applets_settings_custom_highlights"),autocomplete_slideout:p("client_applets_settings_autocomplete_slideout"),theme_thumbnails:_.map(g.app.themes,function(e){return _.template($("#tmpl_theme_thumbnail").html().trim())(e)})};this.$el=$(_.template($("#tmpl_applet_settings").html().trim())(t)),navigator.registerProtocolHandler||this.$(".protocol_handler").remove(),null!==g.utils.notifications.allowed()&&this.$(".notification_enabler").remove(),g.global.settings.on("change",this.loadSettings,this),this.showCategory("appearance")},loadSettings:function(){_.each(g.global.settings.attributes,function(e,t){var n=this.$('[data-setting="'+t+'"]');if(n.length)switch(n.prop("type")){case"checkbox":n.prop("checked",e);break;case"radio":this.$('[data-setting="'+t+'"][value="'+e+'"]').prop("checked",!0);break;case"text":n.val(e);break;case"select-one":this.$('[value="'+e+'"]').prop("selected",!0);break;default:this.$('[data-setting="'+t+'"][data-value="'+e+'"]').addClass("active")}},this)},saveSettings:function(e){var t,n=g.global.settings,i=$(e.currentTarget);switch(e.currentTarget.type){case"checkbox":t=i.is(":checked");break;case"radio":case"text":t=i.val();break;case"select-one":t=$(e.currentTarget[i.prop("selectedIndex")]).val();break;default:t=i.data("value")}n.set(i.data("setting"),t),n.saveOne(i.data("setting"))},selectTheme:function(e){e.preventDefault(),this.$('[data-setting="theme"].active').removeClass("active"),$(e.currentTarget).addClass("active").trigger("change")},registerProtocol:function(e){e.preventDefault(),navigator.registerProtocolHandler("irc",document.location.origin+g.app.get("base_path")+"/%s","Kiwi IRC"),navigator.registerProtocolHandler("ircs",document.location.origin+g.app.get("base_path")+"/%s","Kiwi IRC")},enableNotifications:function(e){e.preventDefault();var t=g.utils.notifications;t.requestPermission().always(_.bind(function(){null!==t.allowed()&&this.$(".notification_enabler").remove()},this))},showCategory:function(e){this.$(".settings-category").removeClass("active"),this.$(".settings-category-"+e).addClass("active"),this.$(".show-category").removeClass("active"),this.$(".show-category-"+e).addClass("active"),this.loadSettings()},onClickShowCategory:function(e){var t=$(e.currentTarget).data("category");t&&this.showCategory(t)}}),t=Backbone.Model.extend({initialize:function(){this.set("title",p("client_applets_settings_title")),this.view=new e;
}});g.model.Applet.register("kiwi_settings",t)}(),function(){var e=Backbone.View.extend({events:{"click .chan":"chanClick","click .channel_name_title":"sortChannelsByNameClick","click .users_title":"sortChannelsByUsersClick"},initialize:function(e){var t={channel_name:g.global.i18n.translate("client_applets_chanlist_channelname").fetch(),users:g.global.i18n.translate("client_applets_chanlist_users").fetch(),topic:g.global.i18n.translate("client_applets_chanlist_topic").fetch()};this.$el=$(_.template($("#tmpl_channel_list").html().trim())(t)),this.channels=[],this.order="",this.waiting=!1},render:function(){var e,t=$("table",this.$el),n=t.children("tbody:first").detach();switch(0==$(".applet_chanlist .users_title").find("span.chanlist_sort_users").length?this.$(".users_title").append('<span class="chanlist_sort_users">&nbsp;&nbsp;</span>'):(this.$(".users_title span.chanlist_sort_users").removeClass("fa fa-sort-desc"),this.$(".users_title span.chanlist_sort_users").removeClass("fa fa-sort-asc")),0==$(".applet_chanlist .channel_name_title").find("span.chanlist_sort_names").length?this.$(".channel_name_title").append('<span class="chanlist_sort_names">&nbsp;&nbsp;</span>'):(this.$(".channel_name_title span.chanlist_sort_names").removeClass("fa fa-sort-desc"),this.$(".channel_name_title span.chanlist_sort_names").removeClass("fa fa-sort-asc")),this.order){case"user_desc":default:this.$(".users_title span.chanlist_sort_users").addClass("fa fa-sort-asc");break;case"user_asc":this.$(".users_title span.chanlist_sort_users").addClass("fa fa-sort-desc");break;case"name_asc":this.$(".channel_name_title span.chanlist_sort_names").addClass("fa fa-sort-desc");break;case"name_desc":this.$(".channel_name_title span.chanlist_sort_names").addClass("fa fa-sort-asc")}for(this.channels=this.sortChannels(this.channels,this.order),e=0;e<this.channels.length;e++)n[0].appendChild(this.channels[e].dom);t[0].appendChild(n[0])},reset:function(){this.$("tbody").empty(),this.channels=[],this.order="",this.waiting=!1},chanClick:function(e){e.target?g.gateway.join(null,$(e.target).data("channel")):g.gateway.join(null,$(e.srcElement).data("channel"))},sortChannelsByNameClick:function(e){this.order="name_asc"==this.order?"name_desc":"name_asc",this.sortChannelsClick()},sortChannelsByUsersClick:function(e){this.order="user_desc"==this.order||""==this.order?"user_asc":"user_desc",this.sortChannelsClick()},sortChannelsClick:function(){this.render()},sortChannels:function(e,t){var n=[],i=[];return _.each(e,function(e,t){n.push({chan_idx:t,num_users:e.num_users,channel:e.channel})}),n.sort(function(e,n){switch(t){case"user_asc":return e.num_users-n.num_users;case"user_desc":return n.num_users-e.num_users;case"name_asc":if(e.channel.toLowerCase()>n.channel.toLowerCase())return 1;if(e.channel.toLowerCase()<n.channel.toLowerCase())return-1;case"name_desc":if(e.channel.toLowerCase()<n.channel.toLowerCase())return 1;if(e.channel.toLowerCase()>n.channel.toLowerCase())return-1;default:return n.num_users-e.num_users}return 0}),_.each(n,function(t){i.push(e[t.chan_idx])}),i}}),t=Backbone.Model.extend({initialize:function(){this.set("title",g.global.i18n.translate("client_applets_chanlist_channellist").fetch()),this.view=new e,this.network=g.global.components.Network(),this.network.on("list_channel",this.onListChannel,this),this.network.on("list_start",this.onListStart,this)},onListChannel:function(e){this.addChannel(e.chans)},onListStart:function(e){this.view.reset()},addChannel:function(e){var t=this;_.isArray(e)||(e=[e]),_.each(e,function(e){var n;n=document.createElement("tr"),n.innerHTML='<td class="chanlist_name"><a class="chan" data-channel="'+e.channel+'">'+_.escape(e.channel)+'</a></td><td class="chanlist_num_users" style="text-align: center;">'+e.num_users+'</td><td style="padding-left: 2em;" class="chanlist_topic">'+l(_.escape(e.topic))+"</td>",e.dom=n,t.view.channels.push(e)}),t.view.waiting||(t.view.waiting=!0,_.defer(function(){t.view.render(),t.view.waiting=!1}))},dispose:function(){this.view.channels=null,this.view.unbind(),this.view.$el.html(""),this.view.remove(),this.view=null,this.network.off()}});g.model.Applet.register("kiwi_chanlist",t)}(),function(){var e=Backbone.View.extend({events:{"click .btn_save":"onSave"},initialize:function(e){var t=this,n={save:g.global.i18n.translate("client_applets_scripteditor_save").fetch()};this.$el=$(_.template($("#tmpl_script_editor").html().trim())(n)),this.model.on("applet_loaded",function(){t.$el.parent().css("height","100%"),$script(g.app.get("base_path")+"/assets/libs/ace/ace.js",function(){t.createAce()})})},createAce:function(){var e="editor_"+Math.floor(1e7*Math.random()).toString();this.editor_id=e,this.$el.find(".editor").attr("id",e),this.editor=ace.edit(e),this.editor.setTheme("ace/theme/monokai"),this.editor.getSession().setMode("ace/mode/javascript");var t=g.global.settings.get("user_script")||"";this.editor.setValue(t)},onSave:function(e){var t,n;t="var network = kiwi.components.Network();\n",t+="var input = kiwi.components.ControlInput();\n",t+="var events = kiwi.components.Events();\n",t+=this.editor.getValue()+"\n",t+="this._dispose = function(){ network.off(); input.off(); events.dispose(); if(this.dispose) this.dispose(); }";try{n=new Function(t),g.user_script&&g.user_script._dispose&&g.user_script._dispose(),g.user_script=new n}catch(e){return void this.setStatus(g.global.i18n.translate("client_applets_scripteditor_error").fetch(e.toString()))}g.global.settings.set("user_script",this.editor.getValue()),g.global.settings.save(),this.setStatus(g.global.i18n.translate("client_applets_scripteditor_saved").fetch()+" :)")},setStatus:function(e){var t=this.$el.find(".toolbar .status");e=e||"",t.slideUp("fast",function(){t.text(e),t.slideDown()})}}),t=Backbone.Model.extend({initialize:function(){this.set("title",g.global.i18n.translate("client_applets_scripteditor_title").fetch()),this.view=new e({model:this})}});g.model.Applet.register("kiwi_script_editor",t)}(),function(){var e=Backbone.View.extend({events:{},initialize:function(e){this.showConnectionDialog()},showConnectionDialog:function(){var e=this.connection_dialog=new g.model.NewConnection;e.populateDefaultServerSettings(),e.view.$el.addClass("initial"),this.$el.append(e.view.$el);var t=$($("#tmpl_new_connection_info").html().trim());t.html()?e.view.infoBoxSet(t):t=null,this.listenTo(e,"connected",this.newConnectionConnected),_.defer(function(){t&&e.view.infoBoxShow(),window==window.top&&e.view.$el.find(".nick").select()})},newConnectionConnected:function(e){this.connection_dialog.view.reset()}}),t=Backbone.Model.extend({initialize:function(){this.view=new e({model:this})}});g.model.Applet.register("kiwi_startup",t)}(),g.utils.notifications=function(){function e(e,n){t.call(this,e,n)}function t(e,i){switch(n.allowed()){case!0:this.notification=new Notification(e,i),_.each(["click","close","error","show"],function(e){this.notification["on"+e]=_.bind(this.trigger,this,e)},this);break;case null:n.requestPermission().done(_.bind(t,this,e,i))}}if(!window.Notification)return{allowed:_.constant(!1),requestPermission:_.constant($.Deferred().reject())};var n={allowed:function(){return"granted"===Notification.permission||"denied"!==Notification.permission&&null},requestPermission:function(){var e=$.Deferred();return Notification.requestPermission(function(t){e["granted"===t?"resolve":"reject"]()}),e.promise()},create:function(t,n){return new e(t,n)}};return _.extend(e.prototype,Backbone.Events,{closed:!1,_closeTimeout:null,closeAfter:function(e){return this.closed||(this.notification?this._closeTimeout=this._closeTimeout||setTimeout(_.bind(this.close,this),e):this.once("show",_.bind(this.closeAfter,this,e))),this},close:function(){return this.notification&&!this.closed&&(this.notification.close(),this.closed=!0),this}}),n}(),g.utils.formatDate=function(){var e,t,n,i,s=!1,a={d:function(){return(this.getDate()<10?"0":"")+this.getDate()},D:function(){return Date.shortDays[this.getDay()]},j:function(){return this.getDate()},l:function(){return Date.longDays[this.getDay()]},N:function(){return this.getDay()+1},S:function(){return this.getDate()%10==1&&11!=this.getDate()?"st":this.getDate()%10==2&&12!=this.getDate()?"nd":this.getDate()%10==3&&13!=this.getDate()?"rd":"th"},w:function(){return this.getDay()},z:function(){var e=new Date(this.getFullYear(),0,1);return Math.ceil((this-e)/864e5)},W:function(){var e=new Date(this.getFullYear(),0,1);return Math.ceil(((this-e)/864e5+e.getDay()+1)/7)},F:function(){return Date.longMonths[this.getMonth()]},m:function(){return(this.getMonth()<9?"0":"")+(this.getMonth()+1)},M:function(){return Date.shortMonths[this.getMonth()]},n:function(){return this.getMonth()+1},t:function(){var e=new Date;return new Date(e.getFullYear(),e.getMonth(),0).getDate()},L:function(){var e=this.getFullYear();return e%400==0||e%100!=0&&e%4==0},o:function(){var e=new Date(this.valueOf());return e.setDate(e.getDate()-(this.getDay()+6)%7+3),e.getFullYear()},Y:function(){return this.getFullYear()},y:function(){return(""+this.getFullYear()).substr(2)},a:function(){return this.getHours()<12?"am":"pm"},A:function(){return this.getHours()<12?"AM":"PM"},B:function(){return Math.floor(1e3*((this.getUTCHours()+1)%24+this.getUTCMinutes()/60+this.getUTCSeconds()/3600)/24)},g:function(){return this.getHours()%12||12},G:function(){return this.getHours()},h:function(){return((this.getHours()%12||12)<10?"0":"")+(this.getHours()%12||12)},H:function(){return(this.getHours()<10?"0":"")+this.getHours()},i:function(){return(this.getMinutes()<10?"0":"")+this.getMinutes()},s:function(){return(this.getSeconds()<10?"0":"")+this.getSeconds()},u:function(){var e=this.getMilliseconds();return(e<10?"00":e<100?"0":"")+e},e:function(){return"Not Yet Supported"},I:function(){for(var e=null,t=0;t<12;++t){var n=new Date(this.getFullYear(),t,1),i=n.getTimezoneOffset();if(null===e)e=i;else{if(i<e){e=i;break}if(i>e)break}}return this.getTimezoneOffset()==e|0},O:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+"00"},P:function(){return(-this.getTimezoneOffset()<0?"-":"+")+(Math.abs(this.getTimezoneOffset()/60)<10?"0":"")+Math.abs(this.getTimezoneOffset()/60)+":00"},T:function(){var e=this.getMonth();this.setMonth(0);var t=this.toTimeString().replace(/^.+ \(?([^\)]+)\)?$/,"$1");return this.setMonth(e),t},Z:function(){return 60*-this.getTimezoneOffset()},c:function(){return this.format("Y-m-d\\TH:i:sP")},r:function(){return this.toString()},U:function(){return this.getTime()/1e3}},o=function(){e=[g.global.i18n.translate("client.libs.date_format.short_months.january").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.february").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.march").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.april").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.may").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.june").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.july").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.august").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.september").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.october").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.november").fetch(),g.global.i18n.translate("client.libs.date_format.short_months.december").fetch()],t=[g.global.i18n.translate("client.libs.date_format.long_months.january").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.february").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.march").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.april").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.may").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.june").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.july").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.august").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.september").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.october").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.november").fetch(),g.global.i18n.translate("client.libs.date_format.long_months.december").fetch()],n=[g.global.i18n.translate("client.libs.date_format.short_days.monday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.tuesday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.wednesday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.thursday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.friday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.saturday").fetch(),g.global.i18n.translate("client.libs.date_format.short_days.sunday").fetch()],i=[g.global.i18n.translate("client.libs.date_format.long_days.monday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.tuesday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.wednesday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.thursday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.friday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.saturday").fetch(),g.global.i18n.translate("client.libs.date_format.long_days.sunday").fetch()],s=!0};return function(e,t){return s||o(),e=e||new Date,t=t||g.global.i18n.translate("client_date_format").fetch(),t.replace(/(\\?)(.)/g,function(t,n,i){return""===n&&a[i]?a[i].call(e):i})}}(),n.prototype.on=function(e,t,n){this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(["on",t,n])},n.prototype.once=function(e,t,n){this._listeners[e]=this._listeners[e]||[],this._listeners[e].push(["once",t,n])},n.prototype.off=function(e,t,n){var i;if("undefined"==typeof e)this._listeners={};else if("undefined"==typeof t)delete this._listeners[e];else if("undefined"==typeof n)for(i=0;i<(this._listeners[e]||[]).length;i++)this._listeners[e][i][1]===t&&(this._listeners[e].splice(i,1),i--);else for(i=0;i<(this._listeners[e]||[]).length;i++)this._listeners[e][i][1]===t&&this._listeners[e][i][2]===n&&(this._listeners[e].splice(i,1),i--)},n.prototype.getListeners=function(e){return this._listeners[e]||[]},n.prototype.createProxy=function(){var e=new n;return e._parent=this._parent||this,e._parent._children.push(e),e},n.prototype.dispose=function(){if(this.off(),this._parent){var e=this._parent._children.indexOf(this);e>-1&&this._parent._children.splice(e,1)}},n.prototype.emit=function(e,n){var i,s=new this.EmitCall(e,n),a=[];for(i=this._children.length-1;i>=0;i--)a=a.concat(this._children[i].getListeners(e));return a=a.concat(this.getListeners(e)),s.then(function(){var e,n=a.length;for(e=0;e<n;e++)"once"===a[e][0]&&(a[e]=t)}),s.callListeners(a),s},n.prototype.EmitCall=function(e,n){function i(e){function i(){var o,l;return a++,e[a]?(l={wait:!1,callback:function(){l.callback=t,i.apply(c)},preventDefault:function(){h=!0}},o=e[a],o[1].call(o[2]||c,l,n),void(l.wait||(l.callback=t,i()))):void s()}var a=-1;return n=n||t,0===e.length?void s():void i()}function s(){l=!0;var e=h?d:r;e=e||[];for(var t=0;t<e.length;t++)"function"==typeof e[t]&&e[t]()}function a(e){return"function"==typeof e&&(r.push(e),l&&!h&&e(),this)}function o(e){return"function"==typeof e&&(d.push(e),l&&h&&e(),this)}var c=this,l=!1,r=[],h=!1,d=[];return{callListeners:i,then:a,catch:o}},"object"==typeof module&&"undefined"!=typeof module.exports&&(module.exports=n),"undefined"==typeof String.prototype.trim&&(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),"undefined"==typeof String.prototype.lpad&&(String.prototype.lpad=function(e,t){var n,i="";for(n=0;n<e;n++)i+=t;return(i+this).slice(-e)}),$.fn.selectRange=function(e,t){var n=$(this)[0];if(n){if("undefined"==typeof e){var i=0;if(document.selection){var s=document.selection.createRange();s.moveStart("character",-n.value.length),i=s.text.length}else(n.selectionStart||"0"==n.selectionStart)&&(i=n.selectionStart);return i}if("undefined"==typeof t&&(t=e),n.setSelectionRange)n.focus(),n.setSelectionRange(e,t);else if(n.createTextRange){var a=n.createTextRange();a.collapse(!0),a.moveEnd("character",t),a.moveStart("character",e),a.select()}else n.selectionStart&&(n.selectionStart=e,n.selectionEnd=t)}}}(window);